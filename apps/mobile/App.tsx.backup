import React, { useEffect, useState } from 'react';
import { View, ActivityIndicator, Text, Platform } from 'react-native';
import { StatusBar } from 'expo-status-bar';
import * as Linking from 'expo-linking';
import Dashboard from './src/Dashboard';
import WelcomeScreen from './src/screens/auth/WelcomeScreen';
import LoginScreen from './src/screens/auth/LoginScreen';
import RegisterScreen from './src/screens/auth/RegisterScreen';
import { useAuth } from './src/hooks/useAuth';
import './global.css';

type AuthScreen = 'welcome' | 'login' | 'register';

// Error boundary for catching runtime errors
class ErrorBoundary extends React.Component<{children: React.ReactNode}, {hasError: boolean, error: Error | null}> {
  constructor(props: {children: React.ReactNode}) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  render() {
    if (this.state.hasError) {
      return (
        <View style={{ flex: 1, backgroundColor: '#141414', justifyContent: 'center', alignItems: 'center', padding: 20 }}>
          <Text style={{ color: '#ff4444', fontSize: 18, marginBottom: 10 }}>應用程式發生錯誤</Text>
          <Text style={{ color: '#999999', fontSize: 14, textAlign: 'center' }}>{this.state.error?.message}</Text>
        </View>
      );
    }
    return this.props.children;
  }
}

function AppContent() {
  const { user, loading, exchangeToken } = useAuth();
  const [initializing, setInitializing] = useState(true);
  const [currentScreen, setCurrentScreen] = useState<AuthScreen>('welcome');

  // Debug logging
  console.log('[App] State:', { user: !!user, loading, initializing, currentScreen });

  useEffect(() => {
    console.log('[App] useEffect - Setting up deep link handler');
    // Handle Deep Link on app launch
    const handleInitialURL = async () => {
      try {
        console.log('[App] Getting initial URL...');
        const initialUrl = await Linking.getInitialURL();
        console.log('[App] Initial URL:', initialUrl);
        if (initialUrl) {
          await handleDeepLink(initialUrl);
        }
      } catch (error) {
        console.error('[App] Error getting initial URL:', error);
      }
      console.log('[App] Setting initializing to false');
      setInitializing(false);
    };

    // Handle Deep Link while app is running
    const subscription = Linking.addEventListener('url', (event: { url: string }) => {
      handleDeepLink(event.url);
    });

    handleInitialURL();

    return () => subscription.remove();
  }, []);

  const handleDeepLink = async (url: string) => {
    try {
      const { queryParams } = Linking.parse(url);
      const token = queryParams?.token as string;

      if (token) {
        console.log('Received transfer token, exchanging for session...');
        const result = await exchangeToken(token);

        if (result.success) {
          console.log('Successfully authenticated via Deep Link');
        } else {
          console.error('Failed to exchange token:', result.error);
        }
      }
    } catch (error) {
      console.error('Error handling deep link:', error);
    }
  };

  if (loading || initializing) {
    console.log('[App] Rendering loading state');
    return (
      <View style={{ flex: 1, backgroundColor: '#141414', alignItems: 'center', justifyContent: 'center' }}>
        <StatusBar style="light" />
        <ActivityIndicator size="large" color="#7C3AED" />
        <Text style={{ color: '#ffffff', marginTop: 20 }}>載入中...</Text>
      </View>
    );
  }

  console.log('[App] Rendering main content, user:', !!user);
  if (!user) {
    return (
      <View style={{ flex: 1, backgroundColor: '#141414' }}>
        <StatusBar style="light" />
        {currentScreen === 'welcome' && (
          <WelcomeScreen
            onNavigateToLogin={() => setCurrentScreen('login')}
            onNavigateToRegister={() => setCurrentScreen('register')}
          />
        )}
        {currentScreen === 'login' && (
          <LoginScreen onNavigateToRegister={() => setCurrentScreen('register')} />
        )}
        {currentScreen === 'register' && (
          <RegisterScreen onNavigateToLogin={() => setCurrentScreen('login')} />
        )}
      </View>
    );
  }

  return (
    <View style={{ flex: 1, backgroundColor: '#141414' }}>
      <StatusBar style="light" />
      <Dashboard />
    </View>
  );
}

export default function App() {
  console.log('[App] Rendering App with ErrorBoundary');
  return (
    <ErrorBoundary>
      <AppContent />
    </ErrorBoundary>
  );
}
