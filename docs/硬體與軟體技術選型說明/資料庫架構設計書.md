# 房東物件管理系統：完整資料庫架構設計書

> **創建日期**: 2026-01-30  
> **創建者**: Project Team  
> **最後修改**: 2026-01-30  
> **修改者**: Project Team  
> **版本**: 1.0  
> **文件類型**: 技術文件

---


> **文件版本**：1.0.0  
> **建立日期**：2026-01-14  
> **適用對象**：開發團隊、資料庫管理員、系統架構師

---

## 目錄

1. [設計理念與業務流程](#1-設計理念與業務流程)
2. [資料表總覽](#2-資料表總覽)
3. [核心資料表詳細設計](#3-核心資料表詳細設計)
4. [資料關聯圖 (ERD)](#4-資料關聯圖-erd)
5. [Row Level Security 安全政策](#5-row-level-security-安全政策)
6. [索引優化策略](#6-索引優化策略)
7. [完整 SQL Migration 腳本](#7-完整-sql-migration-腳本)

---

## 1. 設計理念與業務流程

### 1.1 系統定位

本系統為「房東物件管理語音 AI App」，核心使用者為**房東（Landlord）**，輔以**仲介（Agent）**協助管理。系統需支援以下完整業務週期：

```
物件建檔 → 謄本/權狀上傳 → AI 解析 → 廣告刊登 → 租客篩選 →
簽約入住 → 租金收取 → 維修管理 → 續約/退租 → 財務報表
```

### 1.2 設計原則

| 原則           | 說明                                               |
| -------------- | -------------------------------------------------- |
| **多租戶隔離** | 每位房東/仲介只能存取自己的資料 (RLS)              |
| **彈性擴充**   | 謄本解析結果使用 JSONB，無需頻繁修改 Schema        |
| **完整稽核**   | 所有資料表包含 `created_at`、`updated_at` 時間戳記 |
| **正規化設計** | 避免資料冗餘，確保一致性                           |
| **效能優先**   | 關鍵查詢欄位建立索引                               |

---

## 2. 資料表總覽

### 2.1 資料表清單

| 編號  | 英文名稱                      | 中文名稱             | 中文說明              | 英文說明                                          |
| :---: | :---------------------------- | :------------------- | :-------------------- | :------------------------------------------------ |
|   1   | `users_profile`               | 使用者資料表         | 房東/仲介個人資訊擴充 | User profiles for landlords and agents.           |
|   2   | `Property_Sales`              | 房東的出售物件資料表 | 物件基本銷售資料      | Core data for properties listed for sale.         |
|   3   | `Property_Rentals`            | 房東的租賃物件資料表 | 物件基本租賃資料      | Core data for properties listed for rent.         |
|   4   | `Property_Photos`             | 房東的物件照片表     | 物件照片儲存路徑      | Storage paths and metadata for property images.   |
|   5   | `Property_Inventory`          | 物件設備表           | 傢俱家電清單          | List of furniture and appliances included.        |
|   6   | `Leads_Tenants`               | 房東的潛在租客資料表 | 尚未成交的租屋詢問者  | Potential tenants showing interest.               |
|   7   | `Leads_Buyers`                | 房東的潛在買方資料表 | 尚未成交的買屋詢問者  | Potential buyers showing interest.                |
|   8   | `Contracted_Tenants`          | 房東的成交租客資料表 | 已簽約的租客資料      | Records of tenants who have signed leases.        |
|   9   | `Contracted_Buyers`           | 房東的成交買方資料表 | 已簽約的買方資料      | Records of buyers who have closed the deal.       |
|  10   | `Agent_Directory`             | 仲介名單資料表       | 房東的優質仲介名單    | Contact list of preferred real estate agents.     |
|  11   | `Viewing_Appointments_Tenant` | 潛在租客預約看房表   | 租屋預約看房紀錄      | Scheduling records for rental viewings.           |
|  12   | `Viewing_Appointments_Buyer`  | 潛在買家預約看房表   | 買屋預約看房紀錄      | Scheduling records for sales viewings.            |
|  13   | `Blog_Posts`                  | 部落格資料表         | 文章與知識分享        | Articles and content related to real estate.      |
|  14   | `Interior_Designers`          | 室內裝潢設計師表     | 配合的設計師資料      | Contact info for interior design professionals.   |
|  15   | `Escrow_Legal_Services`       | 律師代書名單表       | 地政士與法律顧問      | Professional list of scriveners and lawyers.      |
|  16   | `Maintenance_Vendors`         | 維修廠商表           | 配合的優質廠商資料    | Directory of reliable repair contractors.         |
|  17   | `Maintenance_Quotes`          | 維修請求報價單       | 維修估價與申請紀錄    | Requests and quotes for repair works.             |
|  18   | `Tenant_Inquiries`            | 租客留言紀錄表       | 租客的反饋與紀錄      | Feedback or messages from potential tenants.      |
|  19   | `Buyer_Intentions`            | 買方意向紀錄表       | 買方的出價意向紀錄    | Records of interest and initial offers.           |
|  20   | `Glossary_Terms`              | 專業詞彙表           | 中英對照詞彙          | Bilingual real estate terminology.                |
|  21   | `AI_Chat_Logs`                | AI 對話紀錄表        | 語音助理對話歷史      | History of interactions with the AI assistant.    |
|  22   | `System_Notifications`        | 通知紀錄表           | 系統通知              | Logs of push notifications and system alerts.     |
|  23   | `Rental_Ledger`               | 租賃收支明細表       | 租金與修繕支出        | Financial records for rental income and expenses. |
|  24   | `Sales_Ledger`                | 買賣收支明細表       | 交易款項與稅費明細    | Financial records for sales transactions.         |
|  25   | `Earnest_Money_Receipts`      | 斡旋金簽收資料表     | 買方支付的斡旋紀錄    | Records of negotiation deposits (Earnest money).  |
|  26   | `Deposit_Receipts`            | 定金簽收資料表       | 簽約前的定金收據      | Documentation for down payments/holding fees.     |
|  27   | `Purchase_Offers`             | 要約書資料表         | 正式的買賣要約        | Formal written offers to purchase property.       |
|  28   | `Payment_Workflow`            | 買賣價金流程資料表   | 履約保證與撥款進度    | Progress tracking of the transaction payments.    |
|  29   | `Lease_Agreements`            | 租賃合約書資料表     | 電子合約或掃描檔      | Digital records of signed rental contracts.       |
|  30   | `Sales_Agreements`            | 買賣合約書資料表     | 正式買賣契約紀錄      | Digital records of signed sales contracts.        |

### 2.2 資料表分類

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         使用者與核心基礎 (Identity & Core)                    │
│  ┌────────────────────────┐                                                 │
│  │      users_profile     │                                                 │
│  └────────────────────────┘                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                         物件資產管理 (Property Assets)                        │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │   Property_Sales   │  │  Property_Rentals  │  │  Property_Photos   │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│  ┌────────────────────┐                                                     │
│  │ Property_Inventory │                                                     │
│  └────────────────────┘                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                         客源與 CRM (Leads & CRM)                             │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │   Leads_Tenants    │  │    Leads_Buyers    │  │  Tenant_Inquiries  │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │  Buyer_Intentions  │  │ View_Appt_Tenant   │  │  View_Appt_Buyer   │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
├─────────────────────────────────────────────────────────────────────────────┤
│                         交易與成交管理 (Transactions)                         │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │ Contracted_Tenants │  │ Contracted_Buyers  │  │  Purchase_Offers   │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │  Lease_Agreements  │  │  Sales_Agreements  │  │  Payment_Workflow  │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
├─────────────────────────────────────────────────────────────────────────────┤
│                         財務與金流紀錄 (Accounting)                           │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │   Rental_Ledger    │  │    Sales_Ledger    │  │ Earnest_Money_Rec. │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│  ┌────────────────────┐                                                     │
│  │  Deposit_Receipts  │                                                     │
│  └────────────────────┘                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                         營運與專業服務 (Operations)                           │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │  Agent_Directory   │  │ Maintenance_Vendors│  │ Maintenance_Quotes │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│  ┌────────────────────┐  ┌────────────────────┐                             │
│  │ Interior_Designers │  │Escrow_Legal_Service│                             │
│  └────────────────────┘  └────────────────────┘                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                         系統支援與 AI (Support & AI)                         │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐     │
│  │     Blog_Posts     │  │   Glossary_Terms   │  │    AI_Chat_Logs    │     │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘     │
│  ┌────────────────────┐                                                     │
│  │System_Notifications│                                                     │
│  └────────────────────┘                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```


---

## 3. 核心資料表詳細設計


### 3.1 使用者資料表 (users_profile)
- **說明**：擴充 Supabase Auth 的使用者資訊。
- **RLS**：`auth.uid() = id` (僅限本人存取)。

| 欄位名稱      | 資料型態    | 必填  | 預設值     | 約束 / 說明                            |
| :------------ | :---------- | :---: | :--------- | :------------------------------------- |
| id            | UUID        |   ✓   | -          | PRIMARY KEY, REFERENCES auth.users(id) |
| role          | TEXT        |   ✓   | 'landlord' | CHECK (role IN ('landlord', 'agent'))  |
| display_name  | TEXT        |   ✓   | -          | 顯示名稱                               |
| phone         | TEXT        |   -   | -          | 聯絡電話                               |
| id_number_enc | TEXT        |   -   | -          | 加密後的身分證字號                     |
| address       | TEXT        |   -   | -          | 通訊地址                               |
| created_at    | TIMESTAMPTZ |   ✓   | NOW()      | 建立時間                               |
| updated_at    | TIMESTAMPTZ |   ✓   | NOW()      | 更新時間                               |


---

### 3.2 房東的出售物件資料表 (Property_Sales)
- **說明**：物件基本銷售資料。
- **RLS**：`auth.uid() = owner_id` (房東及授權仲介存取)。

| 欄位名稱   | 資料型態    | 必填  | 預設值            | 約束 / 說明                                                    |
| :--------- | :---------- | :---: | :---------------- | :------------------------------------------------------------- |
| id         | UUID        |   ✓   | gen_random_uuid() | PRIMARY KEY                                                    |
| owner_id   | UUID        |   ✓   | auth.uid()        | REFERENCES users_profile(id)                                   |
| address    | TEXT        |   ✓   | -                 | 完整地址                                                       |
| price      | NUMERIC     |   ✓   | 0                 | CHECK (price >= 0)                                             |
| status     | TEXT        |   ✓   | 'available'       | CHECK (status IN ('available', 'pending', 'sold', 'archived')) |
| details    | JSONB       |   -   | '{}'              | Jason 結構：坪數、格局、樓層等                                 |
| created_at | TIMESTAMPTZ |   ✓   | NOW()             | 建立時間                                                       |
|            |


---

### 3.3 房東的租賃物件資料表 (Property_Rentals)
- **說明**：物件基本租賃資料。
- **RLS**：`auth.uid() = owner_id`。

| 欄位名稱     | 資料型態 | 必填  | 預設值            | 約束 / 說明                                                         |
| :----------- | :------- | :---: | :---------------- | :------------------------------------------------------------------ |
| id           | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                                                         |
| owner_id     | UUID     |   ✓   | auth.uid()        | REFERENCES users_profile(id)                                        |
| address      | TEXT     |   ✓   | -                 | 完整地址                                                            |
| monthly_rent | NUMERIC  |   ✓   | 0                 | CHECK (monthly_rent >= 0)                                           |
| status       | TEXT     |   ✓   | 'vacant'          | CHECK (status IN ('vacant', 'occupied', 'maintenance', 'archived')) |
| lease_term   | INTEGER  |   -   | 12                | 最短租期 (月)                                                       |


---

### 3.4 房東的物件照片表 (Property_Photos)
- **說明**：物件照片路徑。

| 欄位名稱     | 資料型態 | 必填  | 預設值            | 約束 / 說明                                           |
| :----------- | :------- | :---: | :---------------- | :---------------------------------------------------- |
| id           | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                                           |
| property_id  | UUID     |   ✓   | -                 | REFERENCES Property_Sales(id) OR Property_Rentals(id) |
| storage_path | TEXT     |   ✓   | -                 | Supabase Storage 連接路徑                             |
| is_primary   | BOOLEAN  |   ✓   | FALSE             | 是否為封面照                                          |
| photo_type   | TEXT     |   -   | 'interior'        | 外觀、內裝、格局圖等                                  |



---

### 3.5 物件設備表 (Property_Inventory)
- **說明**：傢俱家電清單。

| 欄位名稱    | 資料型態 | 必填  | 預設值            | 約束 / 說明                     |
| :---------- | :------- | :---: | :---------------- | :------------------------------ |
| id          | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                     |
| property_id | UUID     |   ✓   | -                 | REFERENCES Property_Rentals(id) |
| item_name   | TEXT     |   ✓   | -                 | 設備名稱                        |
| quantity    | INTEGER  |   ✓   | 1                 | CHECK (quantity > 0)            |
| condition   | TEXT     |   -   | 'good'            | 狀態評核                        |



---

### 3.6 房東的潛在租客資料表 (Leads_Tenants)
- **說明**：尚未成交的租屋詢問者。

| 欄位名稱 | 資料型態 | 必填  | 預設值            | 約束 / 說明                       |
| :------- | :------- | :---: | :---------------- | :-------------------------------- |
| id       | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                       |
| owner_id | UUID     |   ✓   | auth.uid()        | 負責追蹤的房東/仲介               |
| name     | TEXT     |   ✓   | -                 | 姓名                              |
| contact  | TEXT     |   ✓   | -                 | 電話或 Email                      |
| status   | TEXT     |   ✓   | 'new'             | new, contacted, viewing, rejected |


---

### 3.7 房東的潛在買方資料表 (Leads_Buyers)
- **說明**：尚未成交的買屋詢問者。

| 欄位名稱    | 資料型態 | 必填  | 預設值            | 約束 / 說明         |
| :---------- | :------- | :---: | :---------------- | :------------------ |
| id          | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY         |
| owner_id    | UUID     |   ✓   | auth.uid()        | 負責追蹤的房東/仲介 |
| budget_low  | NUMERIC  |   -   | 0                 | 預算下限            |
| budget_high | NUMERIC  |   -   | -                 | 預算上限            |


---

### 3.8 房東的成交租客資料表 (Contracted_Tenants)
- **說明**：已簽約的租客資料。

| 欄位名稱     | 資料型態 | 必填  | 預設值            | 約束 / 說明                     |
| :----------- | :------- | :---: | :---------------- | :------------------------------ |
| id           | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                     |
| lease_id     | UUID     |   ✓   | -                 | REFERENCES Lease_Agreements(id) |
| tenant_name  | TEXT     |   ✓   | -                 | 租客姓名                        |
| move_in_date | DATE     |   ✓   | -                 | 入住日期                        |


---

### 3.9 房東的成交買方資料表 (Contracted_Buyers)
- **說明**：已簽約的買方資料。

| 欄位名稱      | 資料型態 | 必填  | 預設值            | 約束 / 說明                   |
| :------------ | :------- | :---: | :---------------- | :---------------------------- |
| id            | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                   |
| sale_id       | UUID     |   ✓   | -                 | REFERENCES Property_Sales(id) |
| contract_date | DATE     |   ✓   | CURRENT_DATE      | 簽約日期                      |
| final_price   | NUMERIC  |   ✓   | -                 | 最終成交價                    |


---

### 3.10 仲介名單資料表 (Agent_Directory)
- **說明**：卓越仲介名單。

| 欄位名稱     | 資料型態 | 必填  | 預設值            | 約束 / 說明                    |
| :----------- | :------- | :---: | :---------------- | :----------------------------- |
| id           | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                    |
| company_name | TEXT     |   ✓   | -                 | 房仲所屬公司                   |
| agent_name   | TEXT     |   ✓   | -                 | 姓名                           |
| rating       | NUMERIC  |   -   | 5.0               | CHECK (rating BETWEEN 0 AND 5) |

---

### 3.11 潛在租客預約看房表 (Viewing_Appointments_Tenant)
- **說明**：租屋預約看房紀錄。
### 3.12 潛在買家預約看房表 (Viewing_Appointments_Buyer)
- **說明**：買屋預約看房紀錄。

| 欄位名稱     | 資料型態    | 必填  | 預設值            | 約束 / 說明                                      |
| :----------- | :---------- | :---: | :---------------- | :----------------------------------------------- |
| id           | UUID        |   ✓   | gen_random_uuid() | PRIMARY KEY                                      |
| lead_id      | UUID        |   ✓   | -                 | REFERENCES Leads_Tenants(id) OR Leads_Buyers(id) |
| scheduled_at | TIMESTAMPTZ |   ✓   | -                 | 預約時間                                         |
| status       | TEXT        |   ✓   | 'confirmed'       | confirmed, cancelled, completed                  |


---

### 3.13 部落格資料表 (Blog_Posts)
- **說明**：知識分享文章。

| 欄位名稱 | 資料型態 | 必填  | 預設值            | 約束 / 說明   |
| :------- | :------- | :---: | :---------------- | :------------ |
| id       | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY   |
| title    | TEXT     |   ✓   | -                 | 標題          |
| content  | TEXT     |   ✓   | -                 | Markdown 內容 |
| tags     | TEXT[]   |   -   | '{}'              | 標籤陣列      |

---

### 3.14 室內裝潢設計師表 (Interior_Designers)
- **說明**：配合的設計師資料。
### 3.15 律師代書名單表 (Escrow_Legal_Services)
- **說明**：地政士與法律顧問。

| 欄位名稱     | 資料型態 | 必填  | 預設值            | 約束 / 說明 |
| :----------- | :------- | :---: | :---------------- | :---------- |
| id           | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY |
| name         | TEXT     |   ✓   | -                 | 姓名/名稱   |
| contact_info | JSONB    |   -   | '{}'              | 二維資料    |

### 3.16 維修廠商表 (Maintenance_Vendors)
- **說明**：配合的優質維修廠商。

| 欄位名稱    | 資料型態 | 必填  | 預設值            | 約束 / 說明          |
| :---------- | :------- | :---: | :---------------- | :------------------- |
| id          | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY          |
| vendor_name | TEXT     |   ✓   | -                 | 廠商名稱             |
| specialty   | TEXT     |   ✓   | -                 | 電、水、冷氣、泥作等 |

---

### 3.17 維修請求報價單 (Maintenance_Quotes)
- **說明**：維修估價與申請紀錄。

| 欄位名稱        | 資料型態 | 必填  | 預設值            | 約束 / 說明                        |
| :-------------- | :------- | :---: | :---------------- | :--------------------------------- |
| id              | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                        |
| property_id     | UUID     |   ✓   | -                 | REFERENCES Property_Rentals(id)    |
| vendor_id       | UUID     |   ✓   | -                 | REFERENCES Maintenance_Vendors(id) |
| quoted_amount   | NUMERIC  |   ✓   | 0                 | 報價金額                           |
| quote_file_path | TEXT     |   -   | -                 | 報價單檔案路徑                     |


---

### 3.18 租客留言紀錄表 (Tenant_Inquiries)
- **說明**：租客的反饋與紀錄。
### 3.19 買方意向紀錄表 (Buyer_Intentions)
- **說明**：買方的出價意向紀錄。

| 欄位名稱 | 資料型態 | 必填  | 預設值            | 約束 / 說明        |
| :------- | :------- | :---: | :---------------- | :----------------- |
| id       | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY        |
| message  | TEXT     |   ✓   | -                 | 反饋內容或出價備註 |

---

### 3.20 專業詞彙表 (Glossary_Terms)
- **說明**：中英對照房產詞彙。

| 欄位名稱 | 資料型態 | 必填  | 預設值 | 約束 / 說明 |
| :------- | :------- | :---: | :----- | :---------- |
| id       | SERIAL   |   ✓   | -      | PRIMARY KEY |
| term_zh  | TEXT     |   ✓   | -      | 中文詞彙    |
| term_en  | TEXT     |   ✓   | -      | 英文對照    |

---

### 3.21 AI 對話紀錄表 (AI_Chat_Logs)
- **說明**：語音助理對話歷史。

| 欄位名稱 | 資料型態 | 必填  | 預設值            | 約束 / 說明                  |
| :------- | :------- | :---: | :---------------- | :--------------------------- |
| id       | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                  |
| user_id  | UUID     |   ✓   | auth.uid()        | REFERENCES users_profile(id) |
| content  | JSONB    |   ✓   | '{}'              | 對話內容                     |


---

### 3.22 通知紀錄表 (System_Notifications)
- **說明**：系統通知系統。

| 欄位名稱 | 資料型態 | 必填  | 預設值            | 約束 / 說明                  |
| :------- | :------- | :---: | :---------------- | :--------------------------- |
| id       | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                  |
| user_id  | UUID     |   ✓   | auth.uid()        | REFERENCES users_profile(id) |
| title    | TEXT     |   ✓   | -                 | 通知主題                     |
| is_read  | BOOLEAN  |   ✓   | FALSE             | 已讀標記                     |


---

### 3.23 租賃收支明細表 (Rental_Ledger)
- **說明**：租金與修繕支出。
### 3.24 買賣收支明細表 (Sales_Ledger)
- **說明**：交易款項與稅費明細。

| 欄位名稱    | 資料型態 | 必填  | 預設值            | 約束 / 說明                                           |
| :---------- | :------- | :---: | :---------------- | :---------------------------------------------------- |
| id          | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                                           |
| property_id | UUID     |   ✓   | -                 | REFERENCES Property_Sales(id) OR Property_Rentals(id) |
| amount      | NUMERIC  |   ✓   | 0                 | 金額                                                  |
| type        | TEXT     |   ✓   | -                 | CHECK (type IN ('income', 'expense'))                 |


---

### 3.25 斡旋金簽收資料表 (Earnest_Money_Receipts)
- **說明**：買方支付的斡旋紀錄。
### 3.26 定金簽收資料表 (Deposit_Receipts)
- **說明**：簽約前的定金收據。

| 欄位名稱 | 資料型態 | 必填  | 預設值            | 約束 / 說明 |
| :------- | :------- | :---: | :---------------- | :---------- |
| id       | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY |
| amount   | NUMERIC  |   ✓   | -                 | 簽收金額    |

---

### 3.27 要約書資料表 (Purchase_Offers)
- **說明**：正式的買賣要約。

| 欄位名稱    | 資料型態 | 必填  | 預設值            | 約束 / 說明                   |
| :---------- | :------- | :---: | :---------------- | :---------------------------- |
| id          | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                   |
| property_id | UUID     |   ✓   | -                 | REFERENCES Property_Sales(id) |
| buyer_id    | UUID     |   ✓   | -                 | REFERENCES Leads_Buyers(id)   |
| offer_price | NUMERIC  |   ✓   | -                 | 欲買價格                      |


---

### 3.28 買賣價金流程資料表 (Payment_Workflow)
- **說明**：履約保證與撥款進度。

| 欄位名稱 | 資料型態 | 必填  | 預設值            | 約束 / 說明                            |
| :------- | :------- | :---: | :---------------- | :------------------------------------- |
| id       | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                            |
| sale_id  | UUID     |   ✓   | -                 | REFERENCES Property_Sales(id)          |
| stage    | TEXT     |   ✓   | 'escrow'          | escrow, tax_payment, transfer, closing |


---

### 3.29 租賃合約書資料表 (Lease_Agreements)
- **說明**：租賃電子合約或掃描檔。
### 3.30 買賣合約書資料表 (Sales_Agreements)
- **說明**：正式買賣契約紀錄。

| 欄位名稱     | 資料型態 | 必填  | 預設值            | 約束 / 說明                                           |
| :----------- | :------- | :---: | :---------------- | :---------------------------------------------------- |
| id           | UUID     |   ✓   | gen_random_uuid() | PRIMARY KEY                                           |
| property_id  | UUID     |   ✓   | -                 | REFERENCES Property_Sales(id) OR Property_Rentals(id) |
| contract_url | TEXT     |   ✓   | -                 | 合約路徑                                              |
| version      | INTEGER  |   ✓   | 1                 | 版本號                                                |



---


---

## 4. 資料關聯圖 (ERD)

以下展示 30 張資料表在 7 大模組下的邏輯關聯，重點在於 `users_profile` 為核心，向下展開資產、交易與財務關係。

```
                                 ┌──────────────────┐
                                 │   auth.users     │ (Supabase)
                                 └────────┬─────────┘
                                          │ 1:1
                                          ▼
                                 ┌──────────────────┐
                                 │  users_profile   │ (Identity)
                                 └─┬──────┬───────┬─┘
           ┌───────────────────────┘      │       └────────────────────────┐
           │ 1:N                          │ 1:N                            │ 1:N
           ▼                              ▼                                ▼
┌────────────────────┐          ┌────────────────────┐          ┌────────────────────┐
│   Property_Sales   │          │  Property_Rentals  │          │    Leads_Tenants   │ (CRM)
└─┬──────┬──────┬────┘          └─┬──────┬──────┬────┘          └────────┬───────────┘
  │      │      │                 │      │      │                        │ 1:N
  │ 1:N  │ 1:N  │ 1:1             │ 1:N  │ 1:N  │ 1:1                    ▼
  ▼      ▼      ▼                 ▼      ▼      ▼               ┌────────────────────┐
┌────────┐┌────────┐┌─────────┐ ┌────────┐┌────────┐┌─────────┐ │ View_Appt_Tenant   │
│ Photos ││ Offers ││ Workflow│ │ Photos ││Inventory││Agreemnt │ └────────┬───────────┘
└────────┘└────────┘└─────────┘ └────────┘└────────┘└─────────┘          │
                                                                         │ (Match)
    (財務關聯)                             (交易關聯)                      │
┌────────────────────┐          ┌────────────────────┐          ┌────────▼───────────┐
│    Sales_Ledger    │◄──┐      │ Contracted_Buyers  │◄─────────┤    Leads_Buyers    │
└────────────────────┘  │      └────────────────────┘    1:1    └────────┬───────────┘
                        │ 1:N                                            │ 1:N
┌────────────────────┐  │       ┌────────────────────┐                   ▼
│   Rental_Ledger    │◄─┴───────┤ Contracted_Tenants │          ┌────────────────────┐
└────────────────────┘   1:N    └────────────────────┘          │  View_Appt_Buyer   │
                                                                └────────────────────┘

 [ 支援模組 ] (與 users_profile 1:N 連結)
 ├─ AI_Chat_Logs
 ├─ System_Notifications
 └─ Blog_Posts / Glossary (全域)

 [ 營運模組 ] (透過 ID 連結相關物件)
 ├─ Maintenance_Vendors <──> Maintenance_Quotes <──> Property_Rentals
 └─ Interior_Designers / Agent_Directory / Escrow_Legal_Services
```


---

## 5. Row Level Security 安全政策

### 5.1 設計原則

- **房東 (Landlord)**：只能存取自己擁有的物件及相關資料
- **仲介 (Agent)**：只能存取被授權代管的物件
- **租客**：透過獨立 API 存取，不直接連接資料庫

### 5.2 RLS Policy 範例

```sql
-- ========================================
-- 啟用 RLS
-- ========================================
ALTER TABLE users_profile ENABLE ROW LEVEL SECURITY;
ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_photos ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_documents ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_amenities ENABLE ROW LEVEL SECURITY;
ALTER TABLE tenants ENABLE ROW LEVEL SECURITY;
ALTER TABLE tenant_applications ENABLE ROW LEVEL SECURITY;
ALTER TABLE leases ENABLE ROW LEVEL SECURITY;
ALTER TABLE lease_payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE maintenance_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE maintenance_vendors ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_appointments ENABLE ROW LEVEL SECURITY;
ALTER TABLE financial_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_conversations ENABLE ROW LEVEL SECURITY;

-- ========================================
-- 使用者資料 Policy
-- ========================================
CREATE POLICY "使用者只能存取自己的資料"
  ON users_profile FOR ALL
  USING (auth.uid() = id);

-- ========================================
-- 物件 Policy（房東或代管仲介）
-- ========================================
CREATE POLICY "房東可存取自己的物件"
  ON properties FOR ALL
  USING (
    auth.uid() = owner_id
    OR auth.uid() = agent_id
  );

-- ========================================
-- 物件照片 Policy（繼承物件權限）
-- ========================================
CREATE POLICY "可存取所屬物件的照片"
  ON property_photos FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 物件文件 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的文件"
  ON property_documents FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 物件設備 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的設備"
  ON property_amenities FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 租客資料 Policy
-- ========================================
CREATE POLICY "房東可存取自己的租客資料"
  ON tenants FOR ALL
  USING (auth.uid() = owner_id);

-- ========================================
-- 租客申請 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的租客申請"
  ON tenant_applications FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 租賃合約 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的租約"
  ON leases FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 租金收款 Policy
-- ========================================
CREATE POLICY "可存取所屬租約的收款紀錄"
  ON lease_payments FOR ALL
  USING (
    lease_id IN (
      SELECT l.id FROM leases l
      JOIN properties p ON l.property_id = p.id
      WHERE p.owner_id = auth.uid() OR p.agent_id = auth.uid()
    )
  );

-- ========================================
-- 維修請求 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的維修請求"
  ON maintenance_requests FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 維修廠商 Policy
-- ========================================
CREATE POLICY "房東可存取自己的維修廠商"
  ON maintenance_vendors FOR ALL
  USING (auth.uid() = owner_id);

-- ========================================
-- 預約看房 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的預約"
  ON property_appointments FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 財務交易 Policy
-- ========================================
CREATE POLICY "房東可存取自己的財務紀錄"
  ON financial_transactions FOR ALL
  USING (auth.uid() = owner_id);

-- ========================================
-- 通知 Policy
-- ========================================
CREATE POLICY "使用者只能存取自己的通知"
  ON notifications FOR ALL
  USING (auth.uid() = user_id);

-- ========================================
-- AI 對話 Policy
-- ========================================
CREATE POLICY "使用者只能存取自己的對話紀錄"
  ON ai_conversations FOR ALL
  USING (auth.uid() = user_id);
```

---

## 6. 索引優化策略

```sql
-- ========================================
-- 主要查詢索引
-- ========================================

-- 物件表索引
CREATE INDEX idx_properties_owner ON properties(owner_id);
CREATE INDEX idx_properties_agent ON properties(agent_id);
CREATE INDEX idx_properties_status ON properties(status);
CREATE INDEX idx_properties_district ON properties(city, district);
CREATE INDEX idx_properties_type ON properties(property_type);
CREATE INDEX idx_properties_rent ON properties(monthly_rent);
CREATE INDEX idx_properties_created ON properties(created_at DESC);

-- JSONB 索引（謄本查詢）
CREATE INDEX idx_properties_transcript ON properties USING GIN (transcript_data);
CREATE INDEX idx_properties_title_deed ON properties USING GIN (title_deed_data);

-- 照片表索引
CREATE INDEX idx_photos_property ON property_photos(property_id);
CREATE INDEX idx_photos_primary ON property_photos(property_id) WHERE is_primary = TRUE;

-- 文件表索引
CREATE INDEX idx_documents_property ON property_documents(property_id);
CREATE INDEX idx_documents_type ON property_documents(document_type);

-- 設備表索引
CREATE INDEX idx_amenities_property ON property_amenities(property_id);
CREATE INDEX idx_amenities_category ON property_amenities(category);

-- 租客表索引
CREATE INDEX idx_tenants_owner ON tenants(owner_id);
CREATE INDEX idx_tenants_name ON tenants(name);

-- 租客申請索引
CREATE INDEX idx_applications_property ON tenant_applications(property_id);
CREATE INDEX idx_applications_status ON tenant_applications(status);

-- 租約表索引
CREATE INDEX idx_leases_property ON leases(property_id);
CREATE INDEX idx_leases_tenant ON leases(tenant_id);
CREATE INDEX idx_leases_status ON leases(status);
CREATE INDEX idx_leases_dates ON leases(start_date, end_date);

-- 收款表索引
CREATE INDEX idx_payments_lease ON lease_payments(lease_id);
CREATE INDEX idx_payments_status ON lease_payments(status);
CREATE INDEX idx_payments_due_date ON lease_payments(due_date);

-- 維修表索引
CREATE INDEX idx_maintenance_property ON maintenance_requests(property_id);
CREATE INDEX idx_maintenance_status ON maintenance_requests(status);
CREATE INDEX idx_maintenance_vendor ON maintenance_requests(vendor_id);

-- 廠商表索引
CREATE INDEX idx_vendors_owner ON maintenance_vendors(owner_id);

-- 預約表索引
CREATE INDEX idx_appointments_property ON property_appointments(property_id);
CREATE INDEX idx_appointments_scheduled ON property_appointments(scheduled_at);
CREATE INDEX idx_appointments_status ON property_appointments(status);

-- 財務表索引
CREATE INDEX idx_transactions_owner ON financial_transactions(owner_id);
CREATE INDEX idx_transactions_property ON financial_transactions(property_id);
CREATE INDEX idx_transactions_date ON financial_transactions(transaction_date);
CREATE INDEX idx_transactions_type ON financial_transactions(transaction_type, category);

-- 通知表索引
CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_unread ON notifications(user_id) WHERE is_read = FALSE;

-- AI 對話索引
CREATE INDEX idx_conversations_user ON ai_conversations(user_id);
CREATE INDEX idx_conversations_session ON ai_conversations(session_id);

-- 詞彙表索引
CREATE INDEX idx_glossary_term_zh ON glossary(term_zh);
CREATE INDEX idx_glossary_term_en ON glossary(term_en);
CREATE INDEX idx_glossary_category ON glossary(category);

-- 全文搜尋索引
CREATE INDEX idx_glossary_search ON glossary USING GIN (
  to_tsvector('simple', term_zh || ' ' || term_en || ' ' || COALESCE(description, ''))
);
```

---

## 7. 完整 SQL Migration 腳本

完整的 migration 腳本請參考：

- [supabase/migrations/](../../../supabase/migrations/)

建議的 migration 檔案結構：

```
supabase/migrations/
├── 20260112000000_initial_schema.sql      # 基礎表結構
├── 20260114000001_users_profile.sql       # 使用者擴充
├── 20260114000002_property_extensions.sql # 物件擴充表
├── 20260114000003_rental_management.sql   # 租賃管理
├── 20260114000004_operations.sql          # 營運管理
├── 20260114000005_ai_support.sql          # AI 支援
├── 20260114000006_glossary.sql            # 詞彙表
├── 20260114000007_rls_policies.sql        # 安全政策
└── 20260114000008_indexes.sql             # 索引優化
```

---

## 版本紀錄

| 版本  | 日期       | 修訂者   | 說明                         |
| ----- | ---------- | -------- | ---------------------------- |
| 1.0.0 | 2026-01-14 | 開發團隊 | 初版建立，完整資料庫架構設計 |

---

> **備註**：本文件為資料庫架構設計參考，實際實作時請依業務需求調整。
