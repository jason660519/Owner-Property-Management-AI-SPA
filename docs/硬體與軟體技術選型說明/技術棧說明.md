# 技術棧說明與選型決策

> **創建日期**: 2026-01-31  
> **創建者**: Claude Sonnet 4.5  
> **最後修改**: 2026-01-31  
> **修改者**: Claude Sonnet 4.5  
> **版本**: 1.0  
> **文件類型**: 技術文件

---

## 📋 完整技術棧清單

### 前端應用

#### 公司官網 (Web App)
- **框架**: Next.js 15.1.6
- **UI 框架**: React 19
- **語言**: TypeScript 5.x
- **樣式**: Tailwind CSS 3.x
- **構建工具**: **Webpack** ⭐
- **狀態管理**: React Context + Hooks
- **動畫**: Framer Motion
- **圖片優化**: Next.js Image Optimization (支援 WebP)
- **字體**: Inter (Google Fonts)

#### 房東管理 App (Mobile App)
- **框架**: Expo 54
- **UI 框架**: React Native
- **語言**: TypeScript 5.x
- **構建工具**: Metro Bundler
- **導航**: Expo Router
- **相機/OCR**: Expo Camera, Expo Image Picker

### 後端服務

#### 主要後端
- **BaaS**: Supabase (自託管本地開發環境)
- **資料庫**: PostgreSQL 15
- **認證**: Supabase Auth
- **儲存**: Supabase Storage (S3 Compatible)
- **實時訂閱**: Supabase Realtime
- **API**: 
  - REST API (PostgREST)
  - GraphQL API (pg_graphql)
  - Edge Functions (Deno)

#### 微服務
- **OCR 服務**: Python 3.11+
  - Tesseract OCR
  - OpenCV
  - FastAPI

### 開發工具

- **Monorepo**: Turborepo
- **版本控制**: Git
- **容器化**: Docker (Supabase 本地服務)
- **包管理器**: npm 10+
- **代碼規範**: ESLint, Prettier
- **測試**: (待建立)

### 部署平台

- **Web**: Vercel
- **Mobile**: Expo Application Services (EAS)
- **後端**: Supabase Cloud (生產環境)

---

## 🔍 關鍵技術選型決策

### 1. 構建工具：Webpack vs Turbopack

#### 決策：Web 端使用 Webpack

**時間**: 2026-01-31  
**決策者**: 開發團隊  

**背景**:
- Next.js 15 引入 Turbopack 作為實驗性功能
- 初期採用 Turbopack 以獲得更快的開發體驗
- 遭遇嚴重的快取資料庫損壞問題

**問題描述**:
1. Turbopack 使用內建 SQLite 快取資料庫
2. 當配置檔（如 `next.config.ts`）變更時，Next.js 自動重啟
3. 重啟過程中 Turbopack 正在寫入快取，被強制終止導致資料庫損壞
4. 錯誤訊息：`Failed to open database: invalid digit found in string`
5. 需要手動清除 `.next/cache` 目錄才能恢復

**評估**:

| 項目         | Turbopack              | Webpack        |
| ------------ | ---------------------- | -------------- |
| 熱更新速度   | ⚡⚡⚡⚡⚡ 極快 (5-10x)     | ⚡⚡⚡ 快         |
| 首次編譯速度 | ⚡⚡⚡⚡⚡ 極快             | ⚡⚡ 中等        |
| 穩定性       | ⚠️ 實驗階段，有已知問題 | ✅ 成熟穩定     |
| 生產環境     | ❌ 不支援               | ✅ 官方標準     |
| 開發體驗     | 🔧 需頻繁清除快取       | ✅ 無需額外維護 |
| 社群支援     | 📚 較少                 | 📚 豐富         |

**最終決策**: 使用 Webpack

**理由**:
1. ✅ **穩定性優先**: 開發環境的穩定性比速度更重要
2. ✅ **減少維護成本**: 不需要團隊成員記住清除快取步驟
3. ✅ **生產環境一致**: Next.js 生產構建仍使用 Webpack
4. ✅ **成熟生態**: Webpack 有豐富的插件和社群支援
5. ⚠️ **可逆決策**: 待 Turbopack 穩定後可再次切換

**實施**:
```json
// apps/web/package.json
{
  "scripts": {
    "dev": "next dev",        // 移除 --turbo
    "build": "next build",
    "start": "next start"
  }
}
```

**影響範圍**:
- ✅ 開發服務器啟動時間增加 5-10 秒
- ✅ 熱更新速度略降（仍然很快）
- ✅ 不再需要手動清除快取
- ✅ 配置檔變更後重啟穩定

---

### 2. Monorepo 工具：Turborepo

**決策**: 使用 Turborepo 管理 Monorepo

**理由**:
1. ✅ Vercel 官方維護，與 Next.js 深度整合
2. ✅ 零配置快取，加速構建
3. ✅ 簡單易用，學習曲線平緩
4. ✅ 完善的並行任務執行

**替代方案比較**:
- **Nx**: 功能更強大，但配置複雜度高
- **Lerna**: 較舊，社群活躍度下降
- **Rush**: 適合大型企業，對本專案過重

---

### 3. 後端：Supabase

**決策**: 使用 Supabase 作為主要後端

**理由**:
1. ✅ 開源 Firebase 替代方案
2. ✅ PostgreSQL 提供完整 SQL 能力
3. ✅ 內建認證、儲存、即時訂閱
4. ✅ 本地開發環境與雲端一致
5. ✅ 降低後端開發成本

**限制與注意事項**:
- ⚠️ 需要 Docker 環境運行本地服務
- ⚠️ Row Level Security (RLS) 需仔細設計
- ⚠️ Edge Functions 使用 Deno，非 Node.js

---

### 4. Mobile：Expo vs React Native CLI

**決策**: 使用 Expo

**理由**:
1. ✅ 快速開發與迭代
2. ✅ 內建相機、圖片處理等原生功能
3. ✅ OTA 更新能力
4. ✅ 簡化原生模組管理

**何時考慮切換到 React Native CLI**:
- 需要複雜原生模組整合
- 需要完全控制原生代碼
- App 體積要求極致優化

---

## 📝 技術債務與未來優化

### 短期（1-3 個月）
- [ ] 建立完整的測試框架（Jest + React Testing Library）
- [ ] 設置 CI/CD 流程
- [ ] 完善錯誤監控（Sentry）

### 中期（3-6 個月）
- [ ] 評估 Turbopack 穩定性，考慮重新啟用
- [ ] 引入狀態管理方案（Zustand / Jotai）
- [ ] 實現離線優先架構（Service Worker + IndexedDB）

### 長期（6-12 個月）
- [ ] 考慮微前端架構（若團隊擴大）
- [ ] 評估 Server Components 的深度應用
- [ ] 建立設計系統文檔與 Storybook

---

## 🔗 相關文檔

- [CHANGELOG.md](../CHANGELOG.md) - 版本變更歷史
- [README.md](../README.md) - 專案概述與快速開始
- [DESIGN.md](./DESIGN.md) - 設計系統規範
- [開發環境快速啟動指南](../deployment-guides/本案開發環境快速啟動指南.md)

---

**版本歷史**:
- **v1.0** (2026-01-31): 初始版本，記錄 Webpack 選型決策
