# èªè­‰ç³»çµ±æ¶æ§‹è¨­è¨ˆ

> **å‰µå»ºæ—¥æœŸ**: 2026-01-31  
> **å‰µå»ºè€…**: Claude Sonnet 4.5  
> **æœ€å¾Œä¿®æ”¹**: 2026-01-31  
> **ä¿®æ”¹è€…**: Claude Sonnet 4.5  
> **ç‰ˆæœ¬**: 1.0  
> **æ–‡ä»¶é¡å‹**: æ¶æ§‹è¨­è¨ˆæ–‡ä»¶

---

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

æœ¬æ–‡ä»¶å®šç¾©äº†æˆ¿æ±ç‰©ä»¶ç®¡ç† AI å¹³å°çš„å®Œæ•´èªè­‰ç³»çµ±æ¶æ§‹ï¼ŒåŸºæ–¼ Supabase Auth å¯¦ä½œå¤šè§’è‰²ã€å¤šç§Ÿæˆ¶çš„å®‰å…¨èªè­‰æ©Ÿåˆ¶ã€‚

**é—œéµæ±ºç­–**:
- âœ… ä½¿ç”¨ Supabase Auth ä½œç‚ºèªè­‰åŸºç¤è¨­æ–½
- âœ… å¯¦ä½œ Row Level Security (RLS) ç¢ºä¿å¤šç§Ÿæˆ¶è³‡æ–™éš”é›¢
- âœ… æ”¯æ´ Email/å¯†ç¢¼ã€OAuth (Google/Facebook/Apple) ç™»å…¥
- âœ… æ¡ç”¨ JWT Token + Refresh Token æ©Ÿåˆ¶

---

## ä¸€ã€èªè­‰ç³»çµ±æ¦‚è§€

### 1.1 ç³»çµ±ç›®æ¨™

1. **å®‰å…¨æ€§**: ä¿è­·ç”¨æˆ¶è³‡æ–™ï¼Œé˜²æ­¢æœªæˆæ¬Šå­˜å–
2. **å¤šè§’è‰²æ”¯æ´**: Super Admin, Landlord, Tenant, Agent
3. **å¤šç§Ÿæˆ¶éš”é›¢**: ç¢ºä¿ä¸åŒæˆ¿æ±çš„è³‡æ–™å®Œå…¨éš”é›¢
4. **ç”¨æˆ¶é«”é©—**: æä¾›æµæš¢çš„ç™»å…¥/è¨»å†Šæµç¨‹
5. **å¯æ“´å±•æ€§**: æ”¯æ´æœªä¾†æ–°å¢çš„èªè­‰æ–¹å¼

### 1.2 æ”¯æ´çš„èªè­‰æ–¹å¼

| èªè­‰æ–¹å¼ | å„ªå…ˆç´š | ç‹€æ…‹ | èªªæ˜ |
|---------|--------|------|------|
| **Email + å¯†ç¢¼** | P0 | âœ… ç«‹å³å¯¦ä½œ | åŸºç¤èªè­‰ï¼Œæœ€ä½ä¾è³´ |
| **Google OAuth** | P1 | â³ ç¬¬äºŒéšæ®µ | æå‡è¨»å†Šè½‰æ›ç‡ |
| **Facebook OAuth** | P1 | â³ ç¬¬äºŒéšæ®µ | ç¤¾ç¾¤å¸³è™Ÿæ•´åˆ |
| **Apple Sign In** | P1 | â³ ç¬¬äºŒéšæ®µ | iOS ç”¨æˆ¶å‹å¥½ |
| **æ‰‹æ©Ÿè™Ÿç¢¼ OTP** | P2 | ğŸ“‹ å¾…è©•ä¼° | éœ€æ•´åˆç°¡è¨Šæœå‹™ |

---

## äºŒã€èªè­‰æµç¨‹è¨­è¨ˆ

### 2.1 è¨»å†Šæµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Supabase Auth
    participant Database
    participant Email Service

    User->>Frontend: å¡«å¯«è¨»å†Šè¡¨å–®<br/>(Email, å¯†ç¢¼, è§’è‰²)
    Frontend->>Frontend: å‰ç«¯é©—è­‰<br/>(Email æ ¼å¼, å¯†ç¢¼å¼·åº¦)
    Frontend->>Supabase Auth: signUp({ email, password })
    Supabase Auth->>Database: å‰µå»º auth.users è¨˜éŒ„
    Database-->>Supabase Auth: è¿”å› user_id
    Supabase Auth->>Email Service: ç™¼é€é©—è­‰éƒµä»¶
    Supabase Auth-->>Frontend: è¿”å› User (email_confirmed: false)
    Frontend->>Database: INSERT users_profile<br/>(user_id, role, metadata)
    Database-->>Frontend: æˆåŠŸ
    Frontend-->>User: é¡¯ç¤º"è«‹æª¢æŸ¥éƒµä»¶é©—è­‰"
    
    User->>Email Service: é»æ“Šé©—è­‰é€£çµ
    Email Service->>Supabase Auth: ç¢ºèª Email
    Supabase Auth->>Database: UPDATE auth.users<br/>(email_confirmed: true)
    Supabase Auth-->>Frontend: é‡å®šå‘è‡³ç™»å…¥é 
    Frontend-->>User: é¡¯ç¤º"é©—è­‰æˆåŠŸï¼Œè«‹ç™»å…¥"
```

### 2.2 ç™»å…¥æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Supabase Auth
    participant Database

    User->>Frontend: è¼¸å…¥ Email + å¯†ç¢¼
    Frontend->>Supabase Auth: signInWithPassword({ email, password })
    Supabase Auth->>Database: é©—è­‰æ†‘è­‰ (auth.users)
    
    alt æ†‘è­‰æ­£ç¢º
        Database-->>Supabase Auth: è¿”å› User
        Supabase Auth->>Supabase Auth: ç”Ÿæˆ JWT Access Token (1å°æ™‚)
        Supabase Auth->>Supabase Auth: ç”Ÿæˆ Refresh Token (30å¤©)
        Supabase Auth-->>Frontend: è¿”å› { user, session }
        Frontend->>Frontend: å„²å­˜ Session (LocalStorage/AsyncStorage)
        Frontend->>Database: SELECT * FROM users_profile<br/>WHERE user_id = ?
        Database-->>Frontend: è¿”å› { role, metadata }
        Frontend->>Frontend: æ ¹æ“šè§’è‰²å°å‘
        
        alt Super Admin
            Frontend-->>User: å°å‘ /super-admin/dashboard
        else Landlord
            Frontend-->>User: å°å‘ /landlord/dashboard
        else Tenant
            Frontend-->>User: å°å‘ /tenant/dashboard
        else Agent
            Frontend-->>User: å°å‘ /agent/dashboard
        end
    else æ†‘è­‰éŒ¯èª¤
        Database-->>Supabase Auth: é©—è­‰å¤±æ•—
        Supabase Auth-->>Frontend: è¿”å›éŒ¯èª¤ (401)
        Frontend-->>User: é¡¯ç¤º"Email æˆ–å¯†ç¢¼éŒ¯èª¤"
    end
```

### 2.3 OAuth ç™»å…¥æµç¨‹ (Google ç¯„ä¾‹)

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Supabase Auth
    participant Google OAuth
    participant Database

    User->>Frontend: é»æ“Š"ä½¿ç”¨ Google ç™»å…¥"
    Frontend->>Supabase Auth: signInWithOAuth({ provider: 'google' })
    Supabase Auth->>Google OAuth: é‡å®šå‘è‡³ Google æˆæ¬Šé 
    User->>Google OAuth: æˆæ¬Šæ‡‰ç”¨å­˜å–
    Google OAuth->>Supabase Auth: è¿”å› Authorization Code
    Supabase Auth->>Google OAuth: äº¤æ› Access Token
    Google OAuth-->>Supabase Auth: è¿”å› User Info + Token
    Supabase Auth->>Database: æª¢æŸ¥ auth.users (email)
    
    alt ç”¨æˆ¶å·²å­˜åœ¨
        Database-->>Supabase Auth: è¿”å›ç¾æœ‰ user_id
    else æ–°ç”¨æˆ¶
        Supabase Auth->>Database: INSERT auth.users
        Database-->>Supabase Auth: è¿”å›æ–° user_id
        Supabase Auth->>Database: INSERT users_profile<br/>(é è¨­è§’è‰²: tenant)
    end
    
    Supabase Auth->>Supabase Auth: ç”Ÿæˆ JWT + Refresh Token
    Supabase Auth-->>Frontend: é‡å®šå‘ + è¿”å› Session
    Frontend->>Database: SELECT role FROM users_profile
    Database-->>Frontend: è¿”å›è§’è‰²
    Frontend-->>User: æ ¹æ“šè§’è‰²å°å‘å„€è¡¨æ¿
```

### 2.4 Token åˆ·æ–°æµç¨‹

```mermaid
sequenceDiagram
    participant Frontend
    participant Supabase Auth
    participant API

    Frontend->>API: ç™¼é€è«‹æ±‚ (Authorization: Bearer <expired_token>)
    API-->>Frontend: è¿”å› 401 Unauthorized
    Frontend->>Frontend: æª¢æ¸¬åˆ° Token éæœŸ
    Frontend->>Supabase Auth: refreshSession({ refresh_token })
    Supabase Auth->>Supabase Auth: é©—è­‰ Refresh Token
    
    alt Refresh Token æœ‰æ•ˆ
        Supabase Auth->>Supabase Auth: ç”Ÿæˆæ–° Access Token
        Supabase Auth-->>Frontend: è¿”å›æ–° Session
        Frontend->>Frontend: æ›´æ–°å„²å­˜çš„ Session
        Frontend->>API: é‡è©¦åŸå§‹è«‹æ±‚ (æ–° Token)
        API-->>Frontend: è¿”å›æˆåŠŸå›æ‡‰
    else Refresh Token éæœŸ/ç„¡æ•ˆ
        Supabase Auth-->>Frontend: è¿”å›éŒ¯èª¤
        Frontend->>Frontend: æ¸…é™¤ Session
        Frontend-->>Frontend: é‡å®šå‘è‡³ç™»å…¥é 
    end
```

---

## ä¸‰ã€è§’è‰²èˆ‡æ¬Šé™ç³»çµ± (RBAC)

### 3.1 è§’è‰²å®šç¾©

| è§’è‰² | è‹±æ–‡åç¨± | æ¬Šé™ç¯„åœ | å…¸å‹ç”¨æˆ¶ |
|------|---------|---------|---------|
| **è¶…ç´šç®¡ç†å“¡** | `super_admin` | å®Œæ•´ç³»çµ±å­˜å–æ¬Šé™ | å¹³å°é‹ç‡Ÿäººå“¡ |
| **æˆ¿æ±** | `landlord` | è‡ªå·±çš„ç‰©ä»¶ã€ç§Ÿå®¢ã€åˆç´„ | æˆ¿å±‹æ‰€æœ‰æ¬Šäºº |
| **ç§Ÿå®¢** | `tenant` | è‡ªå·±çš„ç§Ÿç´„ã€ç¹³è²»è¨˜éŒ„ | æ‰¿ç§Ÿäºº |
| **ä»²ä»‹** | `agent` | ç¶“æ‰‹çš„ç‰©ä»¶èˆ‡å®¢æˆ¶ | æˆ¿åœ°ç”¢ç¶“ç´€äºº |
| **å» å•†** | `service_provider` | ç¶­ä¿®è«‹æ±‚èˆ‡å ±åƒ¹ | ç¶­ä¿®å» å•† |

### 3.2 è§’è‰²æ¬Šé™çŸ©é™£

#### ç‰©ä»¶ç®¡ç† (Properties)

| æ“ä½œ | Super Admin | Landlord | Tenant | Agent |
|------|------------|----------|--------|-------|
| **æŸ¥çœ‹æ‰€æœ‰ç‰©ä»¶** | âœ… | âŒ | âŒ | âŒ |
| **æŸ¥çœ‹è‡ªå·±çš„ç‰©ä»¶** | âœ… | âœ… | âŒ | âœ… (ç¶“æ‰‹) |
| **æ–°å¢ç‰©ä»¶** | âœ… | âœ… | âŒ | âŒ |
| **ç·¨è¼¯ç‰©ä»¶** | âœ… | âœ… (è‡ªå·±) | âŒ | âŒ |
| **åˆªé™¤ç‰©ä»¶** | âœ… | âœ… (è‡ªå·±) | âŒ | âŒ |
| **æŸ¥çœ‹ç‰©ä»¶è©³æƒ…** | âœ… | âœ… (è‡ªå·±) | âœ… (ç§Ÿç”¨) | âœ… (ç¶“æ‰‹) |

#### ç§Ÿå®¢ç®¡ç† (Tenants)

| æ“ä½œ | Super Admin | Landlord | Tenant | Agent |
|------|------------|----------|--------|-------|
| **æŸ¥çœ‹æ‰€æœ‰ç§Ÿå®¢** | âœ… | âŒ | âŒ | âŒ |
| **æŸ¥çœ‹è‡ªå·±çš„ç§Ÿå®¢** | âœ… | âœ… | âŒ | âœ… (ç¶“æ‰‹) |
| **æ–°å¢ç§Ÿå®¢** | âœ… | âœ… | âŒ | âœ… |
| **ç·¨è¼¯ç§Ÿå®¢è³‡æ–™** | âœ… | âœ… (è‡ªå·±) | âŒ | âœ… (ç¶“æ‰‹) |
| **æŸ¥çœ‹ç§Ÿé‡‘è¨˜éŒ„** | âœ… | âœ… (è‡ªå·±) | âœ… (è‡ªå·±) | âŒ |

#### åˆç´„ç®¡ç† (Contracts)

| æ“ä½œ | Super Admin | Landlord | Tenant | Agent |
|------|------------|----------|--------|-------|
| **æŸ¥çœ‹æ‰€æœ‰åˆç´„** | âœ… | âŒ | âŒ | âŒ |
| **æŸ¥çœ‹è‡ªå·±çš„åˆç´„** | âœ… | âœ… | âœ… | âœ… (ç¶“æ‰‹) |
| **å‰µå»ºåˆç´„** | âœ… | âœ… | âŒ | âœ… |
| **ç°½ç½²åˆç´„** | âœ… | âœ… (æˆ¿æ±) | âœ… (ç§Ÿå®¢) | âŒ |
| **çµ‚æ­¢åˆç´„** | âœ… | âœ… (è‡ªå·±) | âŒ | âŒ |

### 3.3 è³‡æ–™åº«è§’è‰²æ˜ å°„

```sql
-- users_profile è¡¨çµæ§‹
CREATE TABLE users_profile (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('super_admin', 'landlord', 'tenant', 'agent', 'service_provider')),
  email TEXT NOT NULL,
  full_name TEXT,
  phone TEXT,
  avatar_url TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å‰µå»ºç´¢å¼•
CREATE INDEX idx_users_profile_user_id ON users_profile(user_id);
CREATE INDEX idx_users_profile_role ON users_profile(role);
```

---

## å››ã€Row Level Security (RLS) ç­–ç•¥

### 4.1 RLS è¨­è¨ˆåŸå‰‡

1. **é è¨­æ‹’çµ•**: æ‰€æœ‰è¡¨æ ¼é è¨­ç¦æ­¢ä»»ä½•å­˜å–
2. **æœ€å°æ¬Šé™**: åƒ…æˆäºˆå¿…è¦çš„æ¬Šé™
3. **è§’è‰²éš”é›¢**: ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒçš„è³‡æ–™
4. **å¤šç§Ÿæˆ¶éš”é›¢**: æˆ¿æ±åªèƒ½çœ‹åˆ°è‡ªå·±çš„è³‡æ–™

### 4.2 users_profile RLS ç­–ç•¥

```sql
-- å•Ÿç”¨ RLS
ALTER TABLE users_profile ENABLE ROW LEVEL SECURITY;

-- ç­–ç•¥ 1: ç”¨æˆ¶å¯æŸ¥çœ‹è‡ªå·±çš„è³‡æ–™
CREATE POLICY "Users can view own profile"
ON users_profile
FOR SELECT
USING (auth.uid() = user_id);

-- ç­–ç•¥ 2: ç”¨æˆ¶å¯æ›´æ–°è‡ªå·±çš„è³‡æ–™ (é™¤äº† role)
CREATE POLICY "Users can update own profile"
ON users_profile
FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id AND role = (SELECT role FROM users_profile WHERE user_id = auth.uid()));

-- ç­–ç•¥ 3: Super Admin å¯æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶
CREATE POLICY "Super admin can view all profiles"
ON users_profile
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM users_profile
    WHERE user_id = auth.uid() AND role = 'super_admin'
  )
);

-- ç­–ç•¥ 4: Super Admin å¯æ›´æ–°æ‰€æœ‰ç”¨æˆ¶
CREATE POLICY "Super admin can update all profiles"
ON users_profile
FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM users_profile
    WHERE user_id = auth.uid() AND role = 'super_admin'
  )
);
```

### 4.3 Properties RLS ç­–ç•¥ç¯„ä¾‹

```sql
-- å‡è¨­ property_rentals è¡¨æœ‰ landlord_id æ¬„ä½
ALTER TABLE property_rentals ENABLE ROW LEVEL SECURITY;

-- ç­–ç•¥ 1: æˆ¿æ±å¯æŸ¥çœ‹è‡ªå·±çš„ç‰©ä»¶
CREATE POLICY "Landlords can view own properties"
ON property_rentals
FOR SELECT
USING (
  landlord_id = auth.uid()
  OR
  EXISTS (
    SELECT 1 FROM users_profile
    WHERE user_id = auth.uid() AND role = 'super_admin'
  )
);

-- ç­–ç•¥ 2: ç§Ÿå®¢å¯æŸ¥çœ‹è‡ªå·±ç§Ÿç”¨çš„ç‰©ä»¶
CREATE POLICY "Tenants can view rented properties"
ON property_rentals
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM lease_agreements
    WHERE property_id = property_rentals.id
    AND tenant_id = auth.uid()
    AND status = 'active'
  )
);

-- ç­–ç•¥ 3: æˆ¿æ±å¯æ–°å¢ç‰©ä»¶
CREATE POLICY "Landlords can insert properties"
ON property_rentals
FOR INSERT
WITH CHECK (
  landlord_id = auth.uid()
  AND
  EXISTS (
    SELECT 1 FROM users_profile
    WHERE user_id = auth.uid() AND role = 'landlord'
  )
);

-- ç­–ç•¥ 4: æˆ¿æ±å¯æ›´æ–°è‡ªå·±çš„ç‰©ä»¶
CREATE POLICY "Landlords can update own properties"
ON property_rentals
FOR UPDATE
USING (landlord_id = auth.uid())
WITH CHECK (landlord_id = auth.uid());

-- ç­–ç•¥ 5: æˆ¿æ±å¯åˆªé™¤è‡ªå·±çš„ç‰©ä»¶
CREATE POLICY "Landlords can delete own properties"
ON property_rentals
FOR DELETE
USING (landlord_id = auth.uid());
```

---

## äº”ã€å®‰å…¨æ€§è¨­è¨ˆ

### 5.1 å¯†ç¢¼å®‰å…¨

**è¦æ±‚**:
- âœ… æœ€å°‘ 8 å€‹å­—å…ƒ
- âœ… è‡³å°‘åŒ…å«ä¸€å€‹å¤§å¯«å­—æ¯
- âœ… è‡³å°‘åŒ…å«ä¸€å€‹å°å¯«å­—æ¯
- âœ… è‡³å°‘åŒ…å«ä¸€å€‹æ•¸å­—
- âœ… å»ºè­°åŒ…å«ç‰¹æ®Šå­—å…ƒ

**å¯¦ä½œ** (å‰ç«¯é©—è­‰):
```typescript
// lib/validators/auth.ts
import { z } from 'zod';

export const passwordSchema = z
  .string()
  .min(8, 'å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒ')
  .regex(/[A-Z]/, 'å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹å¤§å¯«å­—æ¯')
  .regex(/[a-z]/, 'å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹å°å¯«å­—æ¯')
  .regex(/[0-9]/, 'å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹æ•¸å­—')
  .regex(/[^A-Za-z0-9]/, 'å»ºè­°åŒ…å«ç‰¹æ®Šå­—å…ƒ (!@#$%^&*)');

export const signUpSchema = z.object({
  email: z.string().email('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€'),
  password: passwordSchema,
  confirmPassword: z.string(),
  role: z.enum(['landlord', 'tenant', 'agent']),
  fullName: z.string().min(2, 'å§“åè‡³å°‘éœ€è¦ 2 å€‹å­—å…ƒ'),
  phone: z.string().optional(),
}).refine((data) => data.password === data.confirmPassword, {
  message: 'å¯†ç¢¼ä¸ä¸€è‡´',
  path: ['confirmPassword'],
});
```

### 5.2 Session ç®¡ç†

**é…ç½®**:
```typescript
// Supabase é…ç½®
const supabaseConfig = {
  auth: {
    autoRefreshToken: true,           // è‡ªå‹•åˆ·æ–° Token
    persistSession: true,              // æŒä¹…åŒ– Session
    detectSessionInUrl: true,          // å¾ URL æª¢æ¸¬ Session (OAuth)
    flowType: 'pkce',                  // ä½¿ç”¨ PKCE æµç¨‹ (æ›´å®‰å…¨)
  },
  global: {
    headers: {
      'x-application-name': 'owner-property-management',
    },
  },
};
```

**Token ç”Ÿå‘½é€±æœŸ**:
- **Access Token**: 1 å°æ™‚
- **Refresh Token**: 30 å¤©
- **è‡ªå‹•åˆ·æ–°**: åœ¨ Token éæœŸå‰ 5 åˆ†é˜è‡ªå‹•åˆ·æ–°

### 5.3 CSRF é˜²è­·

Supabase Auth å…§å»º PKCE (Proof Key for Code Exchange) æµç¨‹ï¼Œå¯é˜²æ­¢ CSRF æ”»æ“Šã€‚

**é¡å¤–é˜²è­·æªæ–½**:
```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  // åˆ·æ–° Session
  await supabase.auth.getSession();

  return res;
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
};
```

### 5.4 XSS é˜²è­·

**æªæ–½**:
1. âœ… Next.js è‡ªå‹•è½‰ç¾© HTML
2. âœ… ä½¿ç”¨ `dangerouslySetInnerHTML` æ™‚éœ€ç¶“é DOMPurify æ¸…ç†
3. âœ… è¨­ç½® Content Security Policy (CSP)

```typescript
// next.config.ts
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on',
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN',
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff',
  },
  {
    key: 'Referrer-Policy',
    value: 'origin-when-cross-origin',
  },
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline';",
  },
];

module.exports = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ];
  },
};
```

---

## å…­ã€éŒ¯èª¤è™•ç†

### 6.1 å¸¸è¦‹éŒ¯èª¤ç¢¼

| éŒ¯èª¤ç¢¼ | èªªæ˜ | ç”¨æˆ¶è¨Šæ¯ | è™•ç†æ–¹å¼ |
|--------|------|---------|---------|
| `400` | Invalid request | è«‹æ±‚æ ¼å¼éŒ¯èª¤ | æª¢æŸ¥è¡¨å–®é©—è­‰ |
| `401` | Invalid credentials | Email æˆ–å¯†ç¢¼éŒ¯èª¤ | æç¤ºç”¨æˆ¶é‡æ–°è¼¸å…¥ |
| `403` | Email not confirmed | è«‹å…ˆé©—è­‰ Email | æä¾›é‡æ–°ç™¼é€é©—è­‰éƒµä»¶é¸é … |
| `422` | User already registered | æ­¤ Email å·²è¨»å†Š | æä¾›ç™»å…¥é€£çµ |
| `429` | Rate limit exceeded | è«‹æ±‚éæ–¼é »ç¹ | é¡¯ç¤ºç­‰å¾…æ™‚é–“ |
| `500` | Server error | ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ | è¨˜éŒ„éŒ¯èª¤è‡³ Sentry |

### 6.2 éŒ¯èª¤è™•ç†ç¯„ä¾‹

```typescript
// lib/auth.ts
import { AuthError } from '@supabase/supabase-js';

export function handleAuthError(error: AuthError): string {
  switch (error.message) {
    case 'Invalid login credentials':
      return 'Email æˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥';
    case 'Email not confirmed':
      return 'è«‹å…ˆé©—è­‰æ‚¨çš„ Email åœ°å€';
    case 'User already registered':
      return 'æ­¤ Email å·²è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥';
    case 'Password should be at least 8 characters':
      return 'å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒ';
    default:
      console.error('Auth error:', error);
      return 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
  }
}
```

---

## ä¸ƒã€æ¸¬è©¦ç­–ç•¥

### 7.1 å–®å…ƒæ¸¬è©¦

**æ¸¬è©¦ç¯„åœ**:
- âœ… å¯†ç¢¼é©—è­‰é‚è¼¯
- âœ… Email æ ¼å¼é©—è­‰
- âœ… éŒ¯èª¤è™•ç†å‡½æ•¸

```typescript
// __tests__/lib/validators/auth.test.ts
import { passwordSchema, signUpSchema } from '@/lib/validators/auth';

describe('Password Validation', () => {
  it('æ‡‰æ‹’çµ•å°‘æ–¼ 8 å€‹å­—å…ƒçš„å¯†ç¢¼', () => {
    expect(() => passwordSchema.parse('Short1!')).toThrow();
  });

  it('æ‡‰æ‹’çµ•ç¼ºå°‘å¤§å¯«å­—æ¯çš„å¯†ç¢¼', () => {
    expect(() => passwordSchema.parse('lowercase123!')).toThrow();
  });

  it('æ‡‰æ¥å—ç¬¦åˆæ‰€æœ‰è¦å‰‡çš„å¯†ç¢¼', () => {
    expect(() => passwordSchema.parse('ValidPass123!')).not.toThrow();
  });
});
```

### 7.2 æ•´åˆæ¸¬è©¦

**æ¸¬è©¦ç¯„åœ**:
- âœ… è¨»å†Šæµç¨‹
- âœ… ç™»å…¥æµç¨‹
- âœ… Token åˆ·æ–°
- âœ… OAuth æµç¨‹ (Mocked)

```typescript
// __tests__/integration/auth.test.ts
import { createClient } from '@supabase/supabase-js';

describe('Authentication Flow', () => {
  let supabase: any;

  beforeAll(() => {
    supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
  });

  it('æ‡‰æˆåŠŸè¨»å†Šæ–°ç”¨æˆ¶', async () => {
    const { data, error } = await supabase.auth.signUp({
      email: 'test@example.com',
      password: 'TestPass123!',
    });

    expect(error).toBeNull();
    expect(data.user).toBeDefined();
  });

  // æ›´å¤šæ¸¬è©¦...
});
```

### 7.3 RLS æ¸¬è©¦

**æ¸¬è©¦ç­–ç•¥**:
- âœ… é©—è­‰æˆ¿æ±ç„¡æ³•çœ‹åˆ°å…¶ä»–æˆ¿æ±çš„ç‰©ä»¶
- âœ… é©—è­‰ç§Ÿå®¢ç„¡æ³•ä¿®æ”¹ç‰©ä»¶è³‡æ–™
- âœ… é©—è­‰ Super Admin å¯å­˜å–æ‰€æœ‰è³‡æ–™

```sql
-- tests/sql/rls_test.sql

-- æ¸¬è©¦ 1: æˆ¿æ± A ç„¡æ³•æŸ¥çœ‹æˆ¿æ± B çš„ç‰©ä»¶
BEGIN;
  SET LOCAL ROLE authenticated;
  SET LOCAL request.jwt.claims TO '{"sub": "landlord-a-uuid", "role": "authenticated"}';
  
  -- æ‡‰è©²è¿”å› 0 ç­†è¨˜éŒ„
  SELECT COUNT(*) FROM property_rentals WHERE landlord_id = 'landlord-b-uuid';
  -- é æœŸ: 0
ROLLBACK;

-- æ¸¬è©¦ 2: ç§Ÿå®¢ç„¡æ³•æ–°å¢ç‰©ä»¶
BEGIN;
  SET LOCAL ROLE authenticated;
  SET LOCAL request.jwt.claims TO '{"sub": "tenant-uuid", "role": "authenticated"}';
  
  -- æ‡‰è©²æ‹‹å‡ºæ¬Šé™éŒ¯èª¤
  INSERT INTO property_rentals (landlord_id, title) VALUES ('tenant-uuid', 'Test');
  -- é æœŸ: ERROR - new row violates row-level security policy
ROLLBACK;
```

---

## å…«ã€å¯¦æ–½è¨ˆåŠƒ

### 8.1 Phase 1: åŸºç¤èªè­‰ (ç¬¬ 1 é€±)

**ç›®æ¨™**: å¯¦ä½œ Email/å¯†ç¢¼ç™»å…¥èˆ‡è¨»å†Š

- [ ] Day 1-2: å»ºç«‹ Supabase Client èˆ‡ç’°å¢ƒè®Šæ•¸é…ç½®
- [ ] Day 2-3: å¯¦ä½œè¨»å†Šé é¢èˆ‡ API
- [ ] Day 3-4: å¯¦ä½œç™»å…¥é é¢èˆ‡ Session ç®¡ç†
- [ ] Day 4-5: å¯¦ä½œæ¬Šé™å®ˆè¡› (Middleware)
- [ ] Day 5: æ¸¬è©¦èˆ‡é™¤éŒ¯

**äº¤ä»˜ç‰©**:
- âœ… `/login` é é¢
- âœ… `/register` é é¢
- âœ… `lib/supabase/client.ts`
- âœ… `lib/supabase/auth.ts`
- âœ… `middleware.ts`

### 8.2 Phase 2: è§’è‰²æ¬Šé™ (ç¬¬ 2 é€±)

**ç›®æ¨™**: å¯¦ä½œ RBAC èˆ‡ RLS ç­–ç•¥

- [ ] Day 1-2: å»ºç«‹ `users_profile` è¡¨èˆ‡ RLS ç­–ç•¥
- [ ] Day 2-3: å¯¦ä½œè§’è‰²å°å‘é‚è¼¯
- [ ] Day 3-4: ç´°åŒ–æ‰€æœ‰è¡¨çš„ RLS ç­–ç•¥
- [ ] Day 4-5: æ¸¬è©¦æ¬Šé™éš”é›¢

**äº¤ä»˜ç‰©**:
- âœ… RLS Migration æª”æ¡ˆ
- âœ… è§’è‰²å®ˆè¡› Hook (`useRequireRole`)
- âœ… æ¸¬è©¦æ¡ˆä¾‹

### 8.3 Phase 3: OAuth æ•´åˆ (ç¬¬ 3 é€±)

**ç›®æ¨™**: å¯¦ä½œç¤¾ç¾¤å¸³è™Ÿç™»å…¥

- [ ] Day 1: é…ç½® Google OAuth
- [ ] Day 2: é…ç½® Facebook OAuth
- [ ] Day 3: é…ç½® Apple Sign In
- [ ] Day 4-5: æ¸¬è©¦èˆ‡å„ªåŒ–

---

## ä¹ã€ç›£æ§èˆ‡ç¶­è­·

### 9.1 ç›£æ§æŒ‡æ¨™

| æŒ‡æ¨™ | ç›®æ¨™ | ç›£æ§å·¥å…· |
|------|------|---------|
| **ç™»å…¥æˆåŠŸç‡** | â‰¥ 98% | Supabase Dashboard |
| **è¨»å†Šè½‰æ›ç‡** | â‰¥ 60% | Google Analytics |
| **Token åˆ·æ–°å¤±æ•—ç‡** | â‰¤ 1% | Sentry |
| **å¹³å‡ç™»å…¥æ™‚é–“** | â‰¤ 2 ç§’ | Vercel Analytics |

### 9.2 å®‰å…¨å¯©è¨ˆ

**å®šæœŸæª¢æŸ¥**:
- [ ] æ¯æœˆæª¢æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¢º
- [ ] æ¯å­£æª¢æŸ¥ç”¨æˆ¶å¯†ç¢¼å¼·åº¦åˆ†ä½ˆ
- [ ] æ¯å­£é€²è¡Œæ»²é€æ¸¬è©¦

---

## åã€å¸¸è¦‹å•é¡Œ (FAQ)

**Q1: å¿˜è¨˜å¯†ç¢¼æ€éº¼è¾¦ï¼Ÿ**
A: Supabase Auth æä¾› `resetPasswordForEmail()` APIï¼Œç™¼é€é‡è¨­éƒµä»¶ã€‚

**Q2: å¦‚ä½•æ›´æ”¹ç”¨æˆ¶è§’è‰²ï¼Ÿ**
A: åƒ… Super Admin å¯é€éæ›´æ–° `users_profile` è¡¨æ›´æ”¹è§’è‰²ã€‚

**Q3: OAuth ç™»å…¥çš„ç”¨æˆ¶é è¨­è§’è‰²æ˜¯ä»€éº¼ï¼Ÿ**
A: é è¨­ç‚º `tenant`ï¼Œå¯åœ¨é¦–æ¬¡ç™»å…¥å¾Œæç¤ºé¸æ“‡è§’è‰²ã€‚

**Q4: å¦‚ä½•å¯¦ä½œå¤šé‡èº«ä»½é©—è­‰ (MFA)ï¼Ÿ**
A: Supabase æ”¯æ´ TOTP MFAï¼Œå¯åœ¨ Phase 4 åŠ å…¥ã€‚

---

## é™„éŒ„

### A. ç›¸é—œæ–‡ä»¶
- [Supabase Auth å®˜æ–¹æ–‡ä»¶](https://supabase.com/docs/guides/auth)
- [Row Level Security æŒ‡å—](https://supabase.com/docs/guides/auth/row-level-security)
- [Next.js Authentication æœ€ä½³å¯¦è¸](https://nextjs.org/docs/authentication)

### B. ç¨‹å¼ç¢¼ç¯„æœ¬ä½ç½®
- `apps/web/lib/supabase/` - Supabase Client é…ç½®
- `apps/web/app/(auth)/` - èªè­‰é é¢
- `apps/web/middleware.ts` - è·¯ç”±å®ˆè¡›

---

**æ–‡ä»¶ç‹€æ…‹**: âœ… å®Œæˆ  
**ä¸‹æ¬¡å¯©æŸ¥**: 2026-02-07  
**è² è²¬äºº**: æ¶æ§‹å¸« + å‰ç«¯åœ˜éšŠ
