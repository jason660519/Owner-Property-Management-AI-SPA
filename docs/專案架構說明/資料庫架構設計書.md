# 房東物件管理系統：完整資料庫架構設計書

> **文件版本**：1.0.0  
> **建立日期**：2026-01-14  
> **適用對象**：開發團隊、資料庫管理員、系統架構師

---

## 目錄

1. [設計理念與業務流程](#1-設計理念與業務流程)
2. [資料表總覽](#2-資料表總覽)
3. [核心資料表詳細設計](#3-核心資料表詳細設計)
4. [資料關聯圖 (ERD)](#4-資料關聯圖-erd)
5. [Row Level Security 安全政策](#5-row-level-security-安全政策)
6. [索引優化策略](#6-索引優化策略)
7. [完整 SQL Migration 腳本](#7-完整-sql-migration-腳本)

---

## 1. 設計理念與業務流程

### 1.1 系統定位

本系統為「房東物件管理語音 AI App」，核心使用者為**房東（Landlord）**，輔以**仲介（Agent）**協助管理。系統需支援以下完整業務週期：

```
物件建檔 → 謄本/權狀上傳 → AI 解析 → 廣告刊登 → 租客篩選 →
簽約入住 → 租金收取 → 維修管理 → 續約/退租 → 財務報表
```

### 1.2 設計原則

| 原則           | 說明                                               |
| -------------- | -------------------------------------------------- |
| **多租戶隔離** | 每位房東/仲介只能存取自己的資料 (RLS)              |
| **彈性擴充**   | 謄本解析結果使用 JSONB，無需頻繁修改 Schema        |
| **完整稽核**   | 所有資料表包含 `created_at`、`updated_at` 時間戳記 |
| **正規化設計** | 避免資料冗餘，確保一致性                           |
| **效能優先**   | 關鍵查詢欄位建立索引                               |

---

## 2. 資料表總覽

### 2.1 資料表清單

| 編號 | 資料表名稱               | 中文名稱      | 說明                   |
| :--: | ------------------------ | ------------- | ---------------------- |
|  1   | `users_profile`          | 使用者資料表  | 房東/仲介個人資訊擴充  |
|  2   | `properties`             | 物件主表      | 房屋基本資料與謄本解析 |
|  3   | `property_photos`        | 物件照片表    | 房屋照片儲存路徑       |
|  4   | `property_documents`     | 物件文件表    | 權狀、謄本等文件       |
|  5   | `property_amenities`     | 物件設備表    | 傢俱家電清單           |
|  6   | `tenants`                | 租客資料表    | 租客基本資訊           |
|  7   | `tenant_applications`    | 租客申請表    | 租客篩選紀錄           |
|  8   | `leases`                 | 租賃合約表    | 租約資訊               |
|  9   | `lease_payments`         | 租金收款表    | 租金收付紀錄           |
|  10  | `maintenance_requests`   | 維修請求表    | 維修報修紀錄           |
|  11  | `maintenance_vendors`    | 維修廠商表    | 配合廠商資料           |
|  12  | `property_appointments`  | 預約看房表    | 看房預約紀錄           |
|  13  | `financial_transactions` | 財務交易表    | 收支明細               |
|  14  | `notifications`          | 通知紀錄表    | 系統通知               |
|  15  | `ai_conversations`       | AI 對話紀錄表 | 語音助理對話歷史       |
|  16  | `glossary`               | 專業詞彙表    | 中英對照詞彙           |

### 2.2 資料表分類

```
┌─────────────────────────────────────────────────────────────┐
│                      使用者管理層                            │
│  ┌─────────────────┐                                        │
│  │  users_profile  │                                        │
│  └─────────────────┘                                        │
├─────────────────────────────────────────────────────────────┤
│                      物件管理層                              │
│  ┌────────────┐  ┌─────────────────┐  ┌──────────────────┐  │
│  │ properties │──│ property_photos │  │ property_documents│  │
│  └────────────┘  └─────────────────┘  └──────────────────┘  │
│        │         ┌───────────────────┐                      │
│        └─────────│ property_amenities│                      │
│                  └───────────────────┘                      │
├─────────────────────────────────────────────────────────────┤
│                      租賃管理層                              │
│  ┌─────────┐  ┌─────────────────────┐  ┌────────┐          │
│  │ tenants │──│ tenant_applications │──│ leases │          │
│  └─────────┘  └─────────────────────┘  └────────┘          │
│                                             │               │
│                                    ┌────────────────┐       │
│                                    │ lease_payments │       │
│                                    └────────────────┘       │
├─────────────────────────────────────────────────────────────┤
│                      營運管理層                              │
│  ┌──────────────────────┐  ┌─────────────────────┐          │
│  │ maintenance_requests │──│ maintenance_vendors │          │
│  └──────────────────────┘  └─────────────────────┘          │
│  ┌───────────────────────┐  ┌─────────────────┐             │
│  │ financial_transactions│  │ notifications   │             │
│  └───────────────────────┘  └─────────────────┘             │
├─────────────────────────────────────────────────────────────┤
│                      AI 與輔助層                             │
│  ┌──────────────────┐  ┌──────────────────────────┐         │
│  │ ai_conversations │  │ property_appointments    │         │
│  └──────────────────┘  └──────────────────────────┘         │
│  ┌──────────┐                                               │
│  │ glossary │                                               │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 核心資料表詳細設計

### 3.1 使用者資料表 (users_profile)

擴充 Supabase Auth 的使用者資訊。

| 欄位名稱     | 資料型態    | 必填 | 預設值     | 說明                      |
| ------------ | ----------- | :--: | ---------- | ------------------------- |
| id           | UUID        |  ✓   | -          | 主鍵，對應 auth.users(id) |
| role         | TEXT        |  ✓   | 'landlord' | 角色：landlord / agent    |
| display_name | TEXT        |  ✓   | -          | 顯示名稱                  |
| phone        | TEXT        |  -   | -          | 聯絡電話                  |
| id_number    | TEXT        |  -   | -          | 身分證字號（加密儲存）    |
| address      | TEXT        |  -   | -          | 通訊地址                  |
| bank_account | JSONB       |  -   | -          | 銀行帳戶資訊              |
| preferences  | JSONB       |  -   | '{}'       | AI 助理偏好設定           |
| created_at   | TIMESTAMPTZ |  ✓   | NOW()      | 建立時間                  |
| updated_at   | TIMESTAMPTZ |  ✓   | NOW()      | 更新時間                  |

---

### 3.2 物件主表 (properties)

儲存房屋基本資料與謄本解析結果。

| 欄位名稱                 | 資料型態      | 必填 | 預設值            | 說明                                           |
| ------------------------ | ------------- | :--: | ----------------- | ---------------------------------------------- |
| id                       | UUID          |  ✓   | gen_random_uuid() | 主鍵                                           |
| owner_id                 | UUID          |  ✓   | -                 | 房東 ID，FK → auth.users                       |
| agent_id                 | UUID          |  -   | -                 | 代管仲介 ID，FK → auth.users                   |
| **基本資訊**             |
| property_name            | TEXT          |  -   | -                 | 物件名稱（自訂）                               |
| property_type            | TEXT          |  ✓   | -                 | 類型：apartment/building/townhouse/studio/room |
| status                   | TEXT          |  ✓   | 'draft'           | 狀態：draft/listing/rented/maintenance         |
| **地址資訊**             |
| full_address             | TEXT          |  ✓   | -                 | 完整地址                                       |
| city                     | TEXT          |  -   | -                 | 縣市                                           |
| district                 | TEXT          |  -   | -                 | 行政區                                         |
| street                   | TEXT          |  -   | -                 | 路/街                                          |
| building_number          | TEXT          |  -   | -                 | 門牌號碼                                       |
| floor                    | INTEGER       |  -   | -                 | 所在樓層                                       |
| total_floors             | INTEGER       |  -   | -                 | 總樓層數                                       |
| **面積資訊 (單位：坪)**  |
| registered_area          | NUMERIC(10,2) |  -   | -                 | 權狀坪數                                       |
| interior_area            | NUMERIC(10,2) |  -   | -                 | 室內坪數                                       |
| common_area              | NUMERIC(10,2) |  -   | -                 | 公設坪數                                       |
| common_area_ratio        | NUMERIC(5,2)  |  -   | -                 | 公設比 (%)                                     |
| land_area                | NUMERIC(10,2) |  -   | -                 | 土地持分面積                                   |
| **格局**                 |
| bedrooms                 | INTEGER       |  -   | 0                 | 房間數                                         |
| living_rooms             | INTEGER       |  -   | 0                 | 客廳數                                         |
| bathrooms                | INTEGER       |  -   | 0                 | 衛浴數                                         |
| balconies                | INTEGER       |  -   | 0                 | 陽台數                                         |
| **房屋特性**             |
| building_age             | INTEGER       |  -   | -                 | 屋齡（年）                                     |
| orientation              | TEXT          |  -   | -                 | 朝向：east/south/west/north                    |
| has_elevator             | BOOLEAN       |  -   | FALSE             | 有無電梯                                       |
| parking_type             | TEXT          |  -   | -                 | 車位類型：none/flat/mechanical                 |
| parking_number           | TEXT          |  -   | -                 | 車位編號                                       |
| **租賃條件**             |
| monthly_rent             | NUMERIC(10,0) |  -   | -                 | 月租金 (TWD)                                   |
| deposit_months           | INTEGER       |  -   | 2                 | 押金月數                                       |
| management_fee           | NUMERIC(8,0)  |  -   | 0                 | 管理費                                         |
| min_lease_months         | INTEGER       |  -   | 12                | 最短租期（月）                                 |
| available_date           | DATE          |  -   | -                 | 可入住日期                                     |
| **限制條件**             |
| pet_allowed              | BOOLEAN       |  -   | FALSE             | 可養寵物                                       |
| cooking_allowed          | BOOLEAN       |  -   | TRUE              | 可開伙                                         |
| gender_restriction       | TEXT          |  -   | 'none'            | 性別限制：none/male/female                     |
| **謄本解析資料 (JSONB)** |
| transcript_data          | JSONB         |  -   | '{}'              | AI 解析的謄本資料                              |
| title_deed_data          | JSONB         |  -   | '{}'              | AI 解析的權狀資料                              |
| **描述**                 |
| description              | TEXT          |  -   | -                 | 物件描述                                       |
| highlights               | TEXT[]        |  -   | '{}'              | 特色標籤陣列                                   |
| **時間戳記**             |
| created_at               | TIMESTAMPTZ   |  ✓   | NOW()             | 建立時間                                       |
| updated_at               | TIMESTAMPTZ   |  ✓   | NOW()             | 更新時間                                       |

#### transcript_data JSONB 結構範例

```json
{
  "building_number": "台北市大安區0000-000",
  "land_parcel_numbers": ["大安段一小段0000地號"],
  "registration_date": "2020-03-15",
  "cause_of_registration": "買賣",
  "owner_info": {
    "name": "王大明",
    "id_number_masked": "A123***789",
    "ownership_ratio": "全部"
  },
  "building_description": {
    "structure": "鋼筋混凝土造",
    "total_floors": 12,
    "completion_date": "2015-06-20",
    "main_use": "住家用"
  },
  "area_details": {
    "main_building": 25.5,
    "accessory_building": 3.2,
    "common_area": 8.8,
    "total": 37.5
  },
  "other_rights": [
    {
      "type": "抵押權",
      "creditor": "○○銀行",
      "amount": 5000000,
      "registration_date": "2020-03-20"
    }
  ],
  "raw_ocr_text": "...",
  "parse_confidence": 0.95,
  "parsed_at": "2026-01-14T10:30:00Z"
}
```

---

### 3.3 物件照片表 (property_photos)

| 欄位名稱      | 資料型態    | 必填 | 預設值            | 說明                                                   |
| ------------- | ----------- | :--: | ----------------- | ------------------------------------------------------ |
| id            | UUID        |  ✓   | gen_random_uuid() | 主鍵                                                   |
| property_id   | UUID        |  ✓   | -                 | FK → properties                                        |
| storage_path  | TEXT        |  ✓   | -                 | Supabase Storage 路徑                                  |
| file_name     | TEXT        |  -   | -                 | 原始檔名                                               |
| photo_type    | TEXT        |  -   | 'interior'        | 類型：exterior/interior/floor_plan/amenity             |
| room_type     | TEXT        |  -   | -                 | 房間類型：living_room/bedroom/kitchen/bathroom/balcony |
| is_primary    | BOOLEAN     |  -   | FALSE             | 是否為封面照                                           |
| display_order | INTEGER     |  -   | 0                 | 顯示順序                                               |
| caption       | TEXT        |  -   | -                 | 照片說明                                               |
| created_at    | TIMESTAMPTZ |  ✓   | NOW()             | 建立時間                                               |

---

### 3.4 物件文件表 (property_documents)

| 欄位名稱      | 資料型態    | 必填 | 預設值            | 說明                                          |
| ------------- | ----------- | :--: | ----------------- | --------------------------------------------- |
| id            | UUID        |  ✓   | gen_random_uuid() | 主鍵                                          |
| property_id   | UUID        |  ✓   | -                 | FK → properties                               |
| document_type | TEXT        |  ✓   | -                 | 類型：title_deed/transcript/floor_plan/other  |
| storage_path  | TEXT        |  ✓   | -                 | Supabase Storage 路徑                         |
| file_name     | TEXT        |  -   | -                 | 原始檔名                                      |
| is_verified   | BOOLEAN     |  -   | FALSE             | 是否已驗證                                    |
| verified_at   | TIMESTAMPTZ |  -   | -                 | 驗證時間                                      |
| verified_by   | UUID        |  -   | -                 | 驗證人 ID                                     |
| ocr_status    | TEXT        |  -   | 'pending'         | OCR 狀態：pending/processing/completed/failed |
| ocr_result    | JSONB       |  -   | '{}'              | OCR 解析結果                                  |
| notes         | TEXT        |  -   | -                 | 備註                                          |
| created_at    | TIMESTAMPTZ |  ✓   | NOW()             | 建立時間                                      |
| updated_at    | TIMESTAMPTZ |  ✓   | NOW()             | 更新時間                                      |

---

### 3.5 物件設備表 (property_amenities)

| 欄位名稱       | 資料型態    | 必填 | 預設值            | 說明                               |
| -------------- | ----------- | :--: | ----------------- | ---------------------------------- |
| id             | UUID        |  ✓   | gen_random_uuid() | 主鍵                               |
| property_id    | UUID        |  ✓   | -                 | FK → properties                    |
| category       | TEXT        |  ✓   | -                 | 類別：furniture/appliance/facility |
| item_name_zh   | TEXT        |  ✓   | -                 | 設備名稱（中文）                   |
| item_name_en   | TEXT        |  -   | -                 | 設備名稱（英文）                   |
| brand          | TEXT        |  -   | -                 | 品牌                               |
| model          | TEXT        |  -   | -                 | 型號                               |
| condition      | TEXT        |  -   | 'good'            | 狀況：new/good/fair/poor           |
| quantity       | INTEGER     |  -   | 1                 | 數量                               |
| purchase_date  | DATE        |  -   | -                 | 購買日期                           |
| warranty_until | DATE        |  -   | -                 | 保固期限                           |
| notes          | TEXT        |  -   | -                 | 備註                               |
| created_at     | TIMESTAMPTZ |  ✓   | NOW()             | 建立時間                           |

---

### 3.6 租客資料表 (tenants)

| 欄位名稱          | 資料型態      | 必填 | 預設值            | 說明               |
| ----------------- | ------------- | :--: | ----------------- | ------------------ |
| id                | UUID          |  ✓   | gen_random_uuid() | 主鍵               |
| owner_id          | UUID          |  ✓   | -                 | 所屬房東 ID        |
| name              | TEXT          |  ✓   | -                 | 姓名               |
| phone             | TEXT          |  -   | -                 | 聯絡電話           |
| email             | TEXT          |  -   | -                 | Email              |
| id_number         | TEXT          |  -   | -                 | 身分證字號（加密） |
| date_of_birth     | DATE          |  -   | -                 | 出生日期           |
| occupation        | TEXT          |  -   | -                 | 職業               |
| employer          | TEXT          |  -   | -                 | 任職公司           |
| monthly_income    | NUMERIC(10,0) |  -   | -                 | 月收入             |
| emergency_contact | JSONB         |  -   | '{}'              | 緊急聯絡人         |
| previous_landlord | JSONB         |  -   | '{}'              | 前房東資訊         |
| credit_score      | INTEGER       |  -   | -                 | 信用評分           |
| notes             | TEXT          |  -   | -                 | 備註               |
| created_at        | TIMESTAMPTZ   |  ✓   | NOW()             | 建立時間           |
| updated_at        | TIMESTAMPTZ   |  ✓   | NOW()             | 更新時間           |

---

### 3.7 租客申請表 (tenant_applications)

| 欄位名稱             | 資料型態    | 必填 | 預設值            | 說明                                                |
| -------------------- | ----------- | :--: | ----------------- | --------------------------------------------------- |
| id                   | UUID        |  ✓   | gen_random_uuid() | 主鍵                                                |
| property_id          | UUID        |  ✓   | -                 | FK → properties                                     |
| tenant_id            | UUID        |  ✓   | -                 | FK → tenants                                        |
| status               | TEXT        |  ✓   | 'pending'         | 狀態：pending/screening/approved/rejected/withdrawn |
| desired_move_in      | DATE        |  -   | -                 | 期望入住日                                          |
| desired_lease_months | INTEGER     |  -   | -                 | 期望租期                                            |
| occupants_count      | INTEGER     |  -   | 1                 | 入住人數                                            |
| has_pets             | BOOLEAN     |  -   | FALSE             | 是否有寵物                                          |
| pet_details          | TEXT        |  -   | -                 | 寵物說明                                            |
| screening_result     | JSONB       |  -   | '{}'              | 篩選結果                                            |
| rejection_reason     | TEXT        |  -   | -                 | 拒絕原因                                            |
| applied_at           | TIMESTAMPTZ |  ✓   | NOW()             | 申請時間                                            |
| processed_at         | TIMESTAMPTZ |  -   | -                 | 處理時間                                            |

---

### 3.8 租賃合約表 (leases)

| 欄位名稱                 | 資料型態      | 必填 | 預設值            | 說明                                  |
| ------------------------ | ------------- | :--: | ----------------- | ------------------------------------- |
| id                       | UUID          |  ✓   | gen_random_uuid() | 主鍵                                  |
| property_id              | UUID          |  ✓   | -                 | FK → properties                       |
| tenant_id                | UUID          |  ✓   | -                 | FK → tenants                          |
| lease_number             | TEXT          |  -   | -                 | 合約編號                              |
| status                   | TEXT          |  ✓   | 'draft'           | 狀態：draft/active/expired/terminated |
| **租期**                 |
| start_date               | DATE          |  ✓   | -                 | 起租日                                |
| end_date                 | DATE          |  ✓   | -                 | 退租日                                |
| **費用**                 |
| monthly_rent             | NUMERIC(10,0) |  ✓   | -                 | 月租金                                |
| deposit_amount           | NUMERIC(10,0) |  ✓   | -                 | 押金總額                              |
| management_fee           | NUMERIC(8,0)  |  -   | 0                 | 管理費                                |
| parking_fee              | NUMERIC(8,0)  |  -   | 0                 | 車位費                                |
| **付款條件**             |
| payment_day              | INTEGER       |  -   | 1                 | 每月付款日                            |
| payment_method           | TEXT          |  -   | -                 | 付款方式：transfer/cash/auto_debit    |
| **特別條款**             |
| special_terms            | TEXT[]        |  -   | '{}'              | 特別條款陣列                          |
| pet_clause               | TEXT          |  -   | -                 | 寵物條款                              |
| early_termination_clause | TEXT          |  -   | -                 | 提前解約條款                          |
| **文件**                 |
| contract_path            | TEXT          |  -   | -                 | 合約檔案路徑                          |
| signed_at                | TIMESTAMPTZ   |  -   | -                 | 簽約時間                              |
| e_signature_id           | TEXT          |  -   | -                 | 電子簽章 ID                           |
| **時間戳記**             |
| created_at               | TIMESTAMPTZ   |  ✓   | NOW()             | 建立時間                              |
| updated_at               | TIMESTAMPTZ   |  ✓   | NOW()             | 更新時間                              |

---

### 3.9 租金收款表 (lease_payments)

| 欄位名稱         | 資料型態      | 必填 | 預設值            | 說明                                              |
| ---------------- | ------------- | :--: | ----------------- | ------------------------------------------------- |
| id               | UUID          |  ✓   | gen_random_uuid() | 主鍵                                              |
| lease_id         | UUID          |  ✓   | -                 | FK → leases                                       |
| payment_type     | TEXT          |  ✓   | -                 | 類型：rent/deposit/management_fee/utilities/other |
| billing_period   | TEXT          |  -   | -                 | 帳單期間（如：2026-01）                           |
| amount_due       | NUMERIC(10,0) |  ✓   | -                 | 應付金額                                          |
| amount_paid      | NUMERIC(10,0) |  -   | 0                 | 已付金額                                          |
| due_date         | DATE          |  ✓   | -                 | 應付日期                                          |
| paid_date        | DATE          |  -   | -                 | 實付日期                                          |
| status           | TEXT          |  ✓   | 'pending'         | 狀態：pending/partial/paid/overdue                |
| payment_method   | TEXT          |  -   | -                 | 付款方式                                          |
| reference_number | TEXT          |  -   | -                 | 交易編號                                          |
| receipt_path     | TEXT          |  -   | -                 | 收據檔案路徑                                      |
| notes            | TEXT          |  -   | -                 | 備註                                              |
| created_at       | TIMESTAMPTZ   |  ✓   | NOW()             | 建立時間                                          |
| updated_at       | TIMESTAMPTZ   |  ✓   | NOW()             | 更新時間                                          |

---

### 3.10 維修請求表 (maintenance_requests)

| 欄位名稱          | 資料型態      | 必填 | 預設值            | 說明                                                    |
| ----------------- | ------------- | :--: | ----------------- | ------------------------------------------------------- |
| id                | UUID          |  ✓   | gen_random_uuid() | 主鍵                                                    |
| property_id       | UUID          |  ✓   | -                 | FK → properties                                         |
| lease_id          | UUID          |  -   | -                 | FK → leases（如有租客報修）                             |
| reported_by       | TEXT          |  -   | -                 | 報修人：tenant/landlord                                 |
| **維修資訊**      |
| category          | TEXT          |  ✓   | -                 | 類別：plumbing/electrical/appliance/structure/other     |
| title             | TEXT          |  ✓   | -                 | 維修標題                                                |
| description       | TEXT          |  -   | -                 | 詳細描述                                                |
| urgency           | TEXT          |  -   | 'normal'          | 緊急程度：low/normal/high/emergency                     |
| status            | TEXT          |  ✓   | 'reported'        | 狀態：reported/assigned/in_progress/completed/cancelled |
| **照片**          |
| photo_paths       | TEXT[]        |  -   | '{}'              | 維修照片路徑                                            |
| **派工**          |
| vendor_id         | UUID          |  -   | -                 | FK → maintenance_vendors                                |
| assigned_at       | TIMESTAMPTZ   |  -   | -                 | 派工時間                                                |
| scheduled_at      | TIMESTAMPTZ   |  -   | -                 | 預約維修時間                                            |
| **完工**          |
| completed_at      | TIMESTAMPTZ   |  -   | -                 | 完工時間                                                |
| completion_notes  | TEXT          |  -   | -                 | 完工備註                                                |
| completion_photos | TEXT[]        |  -   | '{}'              | 完工照片                                                |
| **費用**          |
| estimated_cost    | NUMERIC(10,0) |  -   | -                 | 預估費用                                                |
| actual_cost       | NUMERIC(10,0) |  -   | -                 | 實際費用                                                |
| paid_by           | TEXT          |  -   | -                 | 費用承擔：landlord/tenant                               |
| **時間戳記**      |
| created_at        | TIMESTAMPTZ   |  ✓   | NOW()             | 建立時間                                                |
| updated_at        | TIMESTAMPTZ   |  ✓   | NOW()             | 更新時間                                                |

---

### 3.11 維修廠商表 (maintenance_vendors)

| 欄位名稱       | 資料型態     | 必填 | 預設值            | 說明           |
| -------------- | ------------ | :--: | ----------------- | -------------- |
| id             | UUID         |  ✓   | gen_random_uuid() | 主鍵           |
| owner_id       | UUID         |  ✓   | -                 | 所屬房東 ID    |
| vendor_name    | TEXT         |  ✓   | -                 | 廠商名稱       |
| contact_person | TEXT         |  -   | -                 | 聯絡人         |
| phone          | TEXT         |  ✓   | -                 | 聯絡電話       |
| email          | TEXT         |  -   | -                 | Email          |
| service_types  | TEXT[]       |  -   | '{}'              | 服務類型陣列   |
| service_areas  | TEXT[]       |  -   | '{}'              | 服務區域陣列   |
| hourly_rate    | NUMERIC(8,0) |  -   | -                 | 時薪           |
| rating         | NUMERIC(2,1) |  -   | -                 | 評分 (1.0-5.0) |
| notes          | TEXT         |  -   | -                 | 備註           |
| is_active      | BOOLEAN      |  -   | TRUE              | 是否啟用       |
| created_at     | TIMESTAMPTZ  |  ✓   | NOW()             | 建立時間       |

---

### 3.12 預約看房表 (property_appointments)

| 欄位名稱            | 資料型態    | 必填 | 預設值            | 說明                                                |
| ------------------- | ----------- | :--: | ----------------- | --------------------------------------------------- |
| id                  | UUID        |  ✓   | gen_random_uuid() | 主鍵                                                |
| property_id         | UUID        |  ✓   | -                 | FK → properties                                     |
| **預約人資訊**      |
| visitor_name        | TEXT        |  ✓   | -                 | 預約人姓名                                          |
| visitor_phone       | TEXT        |  ✓   | -                 | 預約人電話                                          |
| visitor_email       | TEXT        |  -   | -                 | 預約人 Email                                        |
| visitor_type        | TEXT        |  -   | 'individual'      | 類型：individual/agent                              |
| **預約時間**        |
| scheduled_at        | TIMESTAMPTZ |  ✓   | -                 | 預約時間                                            |
| duration_minutes    | INTEGER     |  -   | 30                | 預計時長（分鐘）                                    |
| **狀態**            |
| status              | TEXT        |  ✓   | 'pending'         | 狀態：pending/confirmed/completed/cancelled/no_show |
| confirmed_at        | TIMESTAMPTZ |  -   | -                 | 確認時間                                            |
| cancelled_at        | TIMESTAMPTZ |  -   | -                 | 取消時間                                            |
| cancellation_reason | TEXT        |  -   | -                 | 取消原因                                            |
| **備註**            |
| visitor_notes       | TEXT        |  -   | -                 | 預約人備註                                          |
| landlord_notes      | TEXT        |  -   | -                 | 房東備註                                            |
| feedback            | TEXT        |  -   | -                 | 看房後回饋                                          |
| interested_level    | INTEGER     |  -   | -                 | 興趣程度 (1-5)                                      |
| **時間戳記**        |
| created_at          | TIMESTAMPTZ |  ✓   | NOW()             | 建立時間                                            |
| updated_at          | TIMESTAMPTZ |  ✓   | NOW()             | 更新時間                                            |

---

### 3.13 財務交易表 (financial_transactions)

| 欄位名稱          | 資料型態      | 必填 | 預設值            | 說明                                                                        |
| ----------------- | ------------- | :--: | ----------------- | --------------------------------------------------------------------------- |
| id                | UUID          |  ✓   | gen_random_uuid() | 主鍵                                                                        |
| owner_id          | UUID          |  ✓   | -                 | FK → auth.users                                                             |
| property_id       | UUID          |  -   | -                 | FK → properties（可為空，如整體費用）                                       |
| lease_id          | UUID          |  -   | -                 | FK → leases                                                                 |
| **交易資訊**      |
| transaction_type  | TEXT          |  ✓   | -                 | 類型：income/expense                                                        |
| category          | TEXT          |  ✓   | -                 | 類別：rent/deposit/maintenance/insurance/tax/management_fee/utilities/other |
| amount            | NUMERIC(12,2) |  ✓   | -                 | 金額                                                                        |
| transaction_date  | DATE          |  ✓   | -                 | 交易日期                                                                    |
| description       | TEXT          |  -   | -                 | 說明                                                                        |
| **關聯**          |
| payment_id        | UUID          |  -   | -                 | FK → lease_payments                                                         |
| maintenance_id    | UUID          |  -   | -                 | FK → maintenance_requests                                                   |
| **收據**          |
| receipt_path      | TEXT          |  -   | -                 | 收據檔案路徑                                                                |
| invoice_number    | TEXT          |  -   | -                 | 發票號碼                                                                    |
| **稅務**          |
| is_tax_deductible | BOOLEAN       |  -   | FALSE             | 是否可抵稅                                                                  |
| tax_category      | TEXT          |  -   | -                 | 報稅類別                                                                    |
| **時間戳記**      |
| created_at        | TIMESTAMPTZ   |  ✓   | NOW()             | 建立時間                                                                    |

---

### 3.14 通知紀錄表 (notifications)

| 欄位名稱          | 資料型態    | 必填 | 預設值            | 說明                                                                      |
| ----------------- | ----------- | :--: | ----------------- | ------------------------------------------------------------------------- |
| id                | UUID        |  ✓   | gen_random_uuid() | 主鍵                                                                      |
| user_id           | UUID        |  ✓   | -                 | FK → auth.users                                                           |
| notification_type | TEXT        |  ✓   | -                 | 類型：payment_reminder/maintenance_update/lease_expiry/appointment/system |
| title             | TEXT        |  ✓   | -                 | 標題                                                                      |
| message           | TEXT        |  ✓   | -                 | 內容                                                                      |
| related_entity    | TEXT        |  -   | -                 | 關聯實體類型                                                              |
| related_id        | UUID        |  -   | -                 | 關聯實體 ID                                                               |
| channel           | TEXT[]      |  -   | '{app}'           | 發送管道：app/email/sms                                                   |
| is_read           | BOOLEAN     |  -   | FALSE             | 是否已讀                                                                  |
| read_at           | TIMESTAMPTZ |  -   | -                 | 已讀時間                                                                  |
| created_at        | TIMESTAMPTZ |  ✓   | NOW()             | 建立時間                                                                  |

---

### 3.15 AI 對話紀錄表 (ai_conversations)

| 欄位名稱     | 資料型態    | 必填 | 預設值            | 說明                    |
| ------------ | ----------- | :--: | ----------------- | ----------------------- |
| id           | UUID        |  ✓   | gen_random_uuid() | 主鍵                    |
| user_id      | UUID        |  ✓   | -                 | FK → auth.users         |
| session_id   | TEXT        |  ✓   | -                 | 對話 Session ID         |
| role         | TEXT        |  ✓   | -                 | 角色：user/assistant    |
| message_type | TEXT        |  -   | 'text'            | 類型：text/voice/action |
| content      | TEXT        |  ✓   | -                 | 訊息內容                |
| audio_path   | TEXT        |  -   | -                 | 語音檔案路徑            |
| intent       | TEXT        |  -   | -                 | 意圖分類                |
| entities     | JSONB       |  -   | '{}'              | 實體擷取結果            |
| action_taken | JSONB       |  -   | '{}'              | 執行的動作              |
| created_at   | TIMESTAMPTZ |  ✓   | NOW()             | 建立時間                |

---

### 3.16 專業詞彙表 (glossary)

| 欄位名稱    | 資料型態    | 必填 | 預設值 | 說明         |
| ----------- | ----------- | :--: | ------ | ------------ |
| id          | SERIAL      |  ✓   | -      | 主鍵         |
| term_zh     | TEXT        |  ✓   | -      | 繁體中文     |
| term_en     | TEXT        |  ✓   | -      | 英文         |
| category    | TEXT        |  ✓   | -      | 類別（中文） |
| category_en | TEXT        |  ✓   | -      | 類別（英文） |
| description | TEXT        |  -   | -      | 說明         |
| created_at  | TIMESTAMPTZ |  ✓   | NOW()  | 建立時間     |
| updated_at  | TIMESTAMPTZ |  ✓   | NOW()  | 更新時間     |

---

## 4. 資料關聯圖 (ERD)

```
┌──────────────────┐
│   auth.users     │
│  (Supabase Auth) │
└────────┬─────────┘
         │
         │ 1:1
         ▼
┌──────────────────┐      ┌──────────────────────┐
│  users_profile   │      │ maintenance_vendors  │
└────────┬─────────┘      └──────────────────────┘
         │                           │
         │ 1:N                       │
         ▼                           │
┌──────────────────┐                 │
│   properties     │◄────────────────┘
└────────┬─────────┘        N:1
         │
    ┌────┼────┬─────────────┬─────────────────┐
    │    │    │             │                 │
    │ 1:N│ 1:N│          1:N│              1:N│
    ▼    ▼    ▼             ▼                 ▼
┌───────┐ ┌──────────┐ ┌──────────┐ ┌─────────────────┐
│photos │ │documents │ │amenities │ │  appointments   │
└───────┘ └──────────┘ └──────────┘ └─────────────────┘
         │
         │ 1:N
         ▼
┌──────────────────┐      ┌─────────────────────────┐
│     leases       │◄─────│  tenant_applications    │
└────────┬─────────┘      └───────────┬─────────────┘
         │                            │
    ┌────┼────┐                       │
    │    │    │                       │
 1:N│ 1:N│    │N:1                 N:1│
    ▼    ▼    │                       │
┌──────────┐ ┌┴─────────────────┐     │
│ payments │ │maintenance_req.  │     │
└──────────┘ └──────────────────┘     │
                                      │
                                      ▼
                               ┌──────────────┐
                               │   tenants    │
                               └──────────────┘
```

---

## 5. Row Level Security 安全政策

### 5.1 設計原則

- **房東 (Landlord)**：只能存取自己擁有的物件及相關資料
- **仲介 (Agent)**：只能存取被授權代管的物件
- **租客**：透過獨立 API 存取，不直接連接資料庫

### 5.2 RLS Policy 範例

```sql
-- ========================================
-- 啟用 RLS
-- ========================================
ALTER TABLE users_profile ENABLE ROW LEVEL SECURITY;
ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_photos ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_documents ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_amenities ENABLE ROW LEVEL SECURITY;
ALTER TABLE tenants ENABLE ROW LEVEL SECURITY;
ALTER TABLE tenant_applications ENABLE ROW LEVEL SECURITY;
ALTER TABLE leases ENABLE ROW LEVEL SECURITY;
ALTER TABLE lease_payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE maintenance_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE maintenance_vendors ENABLE ROW LEVEL SECURITY;
ALTER TABLE property_appointments ENABLE ROW LEVEL SECURITY;
ALTER TABLE financial_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_conversations ENABLE ROW LEVEL SECURITY;

-- ========================================
-- 使用者資料 Policy
-- ========================================
CREATE POLICY "使用者只能存取自己的資料"
  ON users_profile FOR ALL
  USING (auth.uid() = id);

-- ========================================
-- 物件 Policy（房東或代管仲介）
-- ========================================
CREATE POLICY "房東可存取自己的物件"
  ON properties FOR ALL
  USING (
    auth.uid() = owner_id
    OR auth.uid() = agent_id
  );

-- ========================================
-- 物件照片 Policy（繼承物件權限）
-- ========================================
CREATE POLICY "可存取所屬物件的照片"
  ON property_photos FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 物件文件 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的文件"
  ON property_documents FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 物件設備 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的設備"
  ON property_amenities FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 租客資料 Policy
-- ========================================
CREATE POLICY "房東可存取自己的租客資料"
  ON tenants FOR ALL
  USING (auth.uid() = owner_id);

-- ========================================
-- 租客申請 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的租客申請"
  ON tenant_applications FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 租賃合約 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的租約"
  ON leases FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 租金收款 Policy
-- ========================================
CREATE POLICY "可存取所屬租約的收款紀錄"
  ON lease_payments FOR ALL
  USING (
    lease_id IN (
      SELECT l.id FROM leases l
      JOIN properties p ON l.property_id = p.id
      WHERE p.owner_id = auth.uid() OR p.agent_id = auth.uid()
    )
  );

-- ========================================
-- 維修請求 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的維修請求"
  ON maintenance_requests FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 維修廠商 Policy
-- ========================================
CREATE POLICY "房東可存取自己的維修廠商"
  ON maintenance_vendors FOR ALL
  USING (auth.uid() = owner_id);

-- ========================================
-- 預約看房 Policy
-- ========================================
CREATE POLICY "可存取所屬物件的預約"
  ON property_appointments FOR ALL
  USING (
    property_id IN (
      SELECT id FROM properties
      WHERE owner_id = auth.uid() OR agent_id = auth.uid()
    )
  );

-- ========================================
-- 財務交易 Policy
-- ========================================
CREATE POLICY "房東可存取自己的財務紀錄"
  ON financial_transactions FOR ALL
  USING (auth.uid() = owner_id);

-- ========================================
-- 通知 Policy
-- ========================================
CREATE POLICY "使用者只能存取自己的通知"
  ON notifications FOR ALL
  USING (auth.uid() = user_id);

-- ========================================
-- AI 對話 Policy
-- ========================================
CREATE POLICY "使用者只能存取自己的對話紀錄"
  ON ai_conversations FOR ALL
  USING (auth.uid() = user_id);
```

---

## 6. 索引優化策略

```sql
-- ========================================
-- 主要查詢索引
-- ========================================

-- 物件表索引
CREATE INDEX idx_properties_owner ON properties(owner_id);
CREATE INDEX idx_properties_agent ON properties(agent_id);
CREATE INDEX idx_properties_status ON properties(status);
CREATE INDEX idx_properties_district ON properties(city, district);
CREATE INDEX idx_properties_type ON properties(property_type);
CREATE INDEX idx_properties_rent ON properties(monthly_rent);
CREATE INDEX idx_properties_created ON properties(created_at DESC);

-- JSONB 索引（謄本查詢）
CREATE INDEX idx_properties_transcript ON properties USING GIN (transcript_data);
CREATE INDEX idx_properties_title_deed ON properties USING GIN (title_deed_data);

-- 照片表索引
CREATE INDEX idx_photos_property ON property_photos(property_id);
CREATE INDEX idx_photos_primary ON property_photos(property_id) WHERE is_primary = TRUE;

-- 文件表索引
CREATE INDEX idx_documents_property ON property_documents(property_id);
CREATE INDEX idx_documents_type ON property_documents(document_type);

-- 設備表索引
CREATE INDEX idx_amenities_property ON property_amenities(property_id);
CREATE INDEX idx_amenities_category ON property_amenities(category);

-- 租客表索引
CREATE INDEX idx_tenants_owner ON tenants(owner_id);
CREATE INDEX idx_tenants_name ON tenants(name);

-- 租客申請索引
CREATE INDEX idx_applications_property ON tenant_applications(property_id);
CREATE INDEX idx_applications_status ON tenant_applications(status);

-- 租約表索引
CREATE INDEX idx_leases_property ON leases(property_id);
CREATE INDEX idx_leases_tenant ON leases(tenant_id);
CREATE INDEX idx_leases_status ON leases(status);
CREATE INDEX idx_leases_dates ON leases(start_date, end_date);

-- 收款表索引
CREATE INDEX idx_payments_lease ON lease_payments(lease_id);
CREATE INDEX idx_payments_status ON lease_payments(status);
CREATE INDEX idx_payments_due_date ON lease_payments(due_date);

-- 維修表索引
CREATE INDEX idx_maintenance_property ON maintenance_requests(property_id);
CREATE INDEX idx_maintenance_status ON maintenance_requests(status);
CREATE INDEX idx_maintenance_vendor ON maintenance_requests(vendor_id);

-- 廠商表索引
CREATE INDEX idx_vendors_owner ON maintenance_vendors(owner_id);

-- 預約表索引
CREATE INDEX idx_appointments_property ON property_appointments(property_id);
CREATE INDEX idx_appointments_scheduled ON property_appointments(scheduled_at);
CREATE INDEX idx_appointments_status ON property_appointments(status);

-- 財務表索引
CREATE INDEX idx_transactions_owner ON financial_transactions(owner_id);
CREATE INDEX idx_transactions_property ON financial_transactions(property_id);
CREATE INDEX idx_transactions_date ON financial_transactions(transaction_date);
CREATE INDEX idx_transactions_type ON financial_transactions(transaction_type, category);

-- 通知表索引
CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_unread ON notifications(user_id) WHERE is_read = FALSE;

-- AI 對話索引
CREATE INDEX idx_conversations_user ON ai_conversations(user_id);
CREATE INDEX idx_conversations_session ON ai_conversations(session_id);

-- 詞彙表索引
CREATE INDEX idx_glossary_term_zh ON glossary(term_zh);
CREATE INDEX idx_glossary_term_en ON glossary(term_en);
CREATE INDEX idx_glossary_category ON glossary(category);

-- 全文搜尋索引
CREATE INDEX idx_glossary_search ON glossary USING GIN (
  to_tsvector('simple', term_zh || ' ' || term_en || ' ' || COALESCE(description, ''))
);
```

---

## 7. 完整 SQL Migration 腳本

完整的 migration 腳本請參考：

- [supabase/migrations/](../../../supabase/migrations/)

建議的 migration 檔案結構：

```
supabase/migrations/
├── 20260112000000_initial_schema.sql      # 基礎表結構
├── 20260114000001_users_profile.sql       # 使用者擴充
├── 20260114000002_property_extensions.sql # 物件擴充表
├── 20260114000003_rental_management.sql   # 租賃管理
├── 20260114000004_operations.sql          # 營運管理
├── 20260114000005_ai_support.sql          # AI 支援
├── 20260114000006_glossary.sql            # 詞彙表
├── 20260114000007_rls_policies.sql        # 安全政策
└── 20260114000008_indexes.sql             # 索引優化
```

---

## 版本紀錄

| 版本  | 日期       | 修訂者   | 說明                         |
| ----- | ---------- | -------- | ---------------------------- |
| 1.0.0 | 2026-01-14 | 開發團隊 | 初版建立，完整資料庫架構設計 |

---

> **備註**：本文件為資料庫架構設計參考，實際實作時請依業務需求調整。
