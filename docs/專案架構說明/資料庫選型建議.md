# 房東管理 SaaS 專案：資料庫選型與架構設計建議書

## 1. 最終決策：採用 Supabase (PostgreSQL)

本專案定位為一套高度自動化的「房東物件管理語音 AI App」。經過對資料結構、開發難度與維護成本的綜合評估，決定採用 **Supabase** 作為核心後端與資料庫解決方案。

### 為什麼選擇 Supabase？
*   **PDF 解析優勢**：原生支援 PostgreSQL 的 `JSONB` 格式，能完美儲存且高效查詢由 AI 解析出的「權狀謄本」複雜資料。
*   **一站式服務**：包含資料庫 (DB)、檔案儲存 (Storage)、身分驗證 (Auth) 與無伺服器函數 (Edge Functions)，無需自行整合多套系統。
*   **安全性 (RLS)**：內建 Row Level Security，能確保「仲介只能看自己的物件」、「房東只能看自己的財報」，天生支援多租戶隔離。

---

## 2. 針對本專案的核心技術方案

### 2.1 謄本資料處理 (PostgreSQL JSONB)
謄本解析後的內容結構不固定（各國格式不同、地號數量不等），使用傳統欄位會過於臃腫或頻繁變更 Schema。
*   **方案**：將解析結果存為 `JSONB`。
*   **價值**：
    *   **彈性**：AI 解析出的新欄位直接丟入 JSON，不需停機修改資料庫。
    *   **高效查詢**：支援 GIN 索引，即使資料存在 JSON 內也能秒查（例如：查詢所有在「大安區」且「總坪數 > 30」的物件）。

### 2.2 媒體檔案儲存 (Supabase Storage)
物件照片與合約 PDF 需要穩定且具備權限控管的空間。
*   **方案**：直接使用內建於 Supabase 的 Storage。
*   **價值**：
    *   與資料庫共享登入權限，不需額外簽署 S3 Token。
    *   支援本地開發模擬，與正式環境程式碼完全一致。

### 2.3 AI 整合 (Rasa & Edge Functions)
*   **方案**：利用 Supabase Edge Functions 處理 LLM/Rasa 的中間邏輯，並直接將對話狀態存回資料庫。

---

## 3. 資料庫架構設計 (核心概念)

### 3.1 關鍵資料表 (SQL Schema)
```sql
-- 1. 物件主表 (Properties)
CREATE TABLE properties (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID REFERENCES auth.users(id), -- 歸屬仲介
    address TEXT NOT NULL,
    status TEXT DEFAULT 'draft',            -- 招租中, 已租, 維修中
    transcript_info JSONB,                  -- PDF 解析內容
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. 物件照片 (Property Photos)
CREATE TABLE property_photos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID REFERENCES properties(id) ON DELETE CASCADE,
    storage_path TEXT NOT NULL,              -- Storage 中的路徑
    is_primary BOOLEAN DEFAULT FALSE,
    display_order INTEGER DEFAULT 0
);

-- 3. 租賃與財務 (Leases)
CREATE TABLE leases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID REFERENCES properties(id),
    tenant_name TEXT,
    rent_amount NUMERIC(15,2),
    start_date DATE,
    end_date DATE
);
```

### 3.2 安全政策 (RLS Policy)
```sql
-- 啟用多租戶隔離：仲介只能看到並修改自己的物件
ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Agent Data Isolation" ON properties FOR ALL USING (auth.uid() = agent_id);
```

---

## 4. 部署與運作環境

### 4.1 本地開發 (Local Env)
使用您的 MSI PC 運行：
*   **Studio (54323)**：管理後台。推薦在此**人工審核** AI 自動填入的 JSON 資料。
*   **API (54321)**：App 與資料庫溝通的樞紐。
*   **Inbucket (54324)**：收發註冊信測試。

### 4.2 儲存策略 (Storage)
*   **照片路徑**：資料庫僅存 `storage_path`。手機端 App 透過該路徑向 Supabase 換取臨時讀取權限。

---

## 5. 總結

✅ **採用 Supabase 是因為它能讓您專注於語音 AI 的核心邏輯，而不用花時間去寫繁瑣的 CRUD 後端程式碼。**

---
**版本：** 1.2.0 (Clean Rewrite)
**更新日期：** 2026-01-13
**負責人：** Owner Real Estate Agent SaaS Team
