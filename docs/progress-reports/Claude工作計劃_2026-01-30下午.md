# Claude Sonnet 4.5 工作計劃報告

> **創建日期**: 2026-01-30  
> **創建者**: Project Team  
> **最後修改**: 2026-01-30  
> **修改者**: Project Team  
> **版本**: 1.0  
> **文件類型**: 進度報告

---

**日期**: 2026-01-30 下午  
**角色**: Database Migration Engineer & System Integration Tester  
**前置工作**: 已完成 68/118 張表格的 Migration 檔案創建 (57.6%)

---

## 📋 當前狀態評估

### ✅ 已完成工作回顧
根據今日上午完成的《資料庫遷移進度報告_2026-01-30》：

| 成果項目 | 數量 | 完成度 |
|---------|------|--------|
| **Migration 檔案** | 3 個新檔案 | ✅ 100% |
| **資料表** | 68/118 張 | ✅ 57.6% |
| **自動化腳本** | 3 個 Python 工具 | ✅ 100% |
| **文檔更新** | 4 份報告 | ✅ 100% |

**已覆蓋的功能模組**：
- ✅ Super Admin 系統管理 (28 張表)
- ✅ Common User 共用功能 (15 張表)
- ✅ Special Features (AI Voice, 客戶管理, 合約, 廠商) (26 張表)

### ⚠️ 發現的關鍵問題

#### 問題 1: 核心物件表已存在於初始 Schema
```sql
# 在 20260122000000_full_schema.sql 中已有：
- Property_Sales (出售物件)
- Property_Rentals (出租物件)
- Property_Photos (物件照片)
- Property_Inventory (物件設備)
```
**影響**: 待完成表格中的 "物件統一視圖 (properties)" 可能與現有表格重複

#### 問題 2: Migration 執行順序未驗證
- 7 個 migration 檔案的依賴關係未測試
- RLS Policy 可能存在交叉引用問題
- 外鍵約束的順序正確性待確認

#### 問題 3: 剩餘 50 張表的優先級評估
根據 `analyze_pending_tables.py` 分析：
- **Priority A (高優先)**: 17 張 - 包含 RBAC、財務、照片儲存
- **Priority B (中高優先)**: 13 張 - 部落格、授權書、謄本記錄
- **Priority C (中優先)**: 13 張 - 社區管理、360圖、OCR解析
- **Priority D/E (低優先)**: 7 張 - 稅費試算、能源效率等

---

## 🎯 今日下午工作目標

### 目標 1: 資料庫整合測試 (核心目標)
**目的**: 驗證已完成的 68 張表是否可正常運作  
**優先級**: ⭐⭐⭐⭐⭐ (最高)

**執行步驟**:
1. 備份當前 Supabase 本地資料庫
2. 執行 `supabase db reset` 完整重建
3. 檢查 Migration 執行結果與錯誤訊息
4. 驗證表格結構與索引正確性
5. 測試 RLS Policy 是否按預期運作

**預期成果**:
- ✅ 所有 Migration 檔案成功執行
- ✅ 68 張表格正確建立
- ✅ 無外鍵約束衝突
- ✅ RLS Policy 運作正常

**風險評估**:
- ⚠️ 可能發現表格命名衝突 (機率: 30%)
- ⚠️ 外鍵循環引用問題 (機率: 15%)
- ⚠️ RLS Policy 語法錯誤 (機率: 20%)

---

### 目標 2: 核心業務表格補完 (次要目標)
**目的**: 補足高優先級的房東核心功能表  
**優先級**: ⭐⭐⭐⭐ (高)

**待建立表格** (Priority A - 8 張):

#### 房東核心管理
1. ✅ `properties` - 物件統一視圖 (已有 view，需確認)
2. ⏳ `property_photos` - 物件照片主檔 (需與現有 Property_Photos 整合)
3. ⏳ `landlord_profile` - 房東個人資料檔
4. ⏳ `viewing_schedules` - 可預約看房時段設定
5. ⏳ `rental_applications` - 租屋申請記錄
6. ⏳ `property_amenities` - 物件設施清單
7. ⏳ `nearby_facilities` - 周邊設施 (已在 landlord_tables.sql，需確認)
8. ⏳ `location_advantages` - 地段優勢描述

**執行策略**:
- **先執行目標1測試**，根據結果決定是否需要調整現有表格
- 若測試通過，則創建新 migration: `20260130_landlord_core_priority_a.sql`
- 若測試失敗，則優先修復問題

---

### 目標 3: 前後端整合驗證 (延伸目標)
**目的**: 確認 Web/Mobile App 能正常連接資料庫  
**優先級**: ⭐⭐⭐ (中)

**測試項目**:
1. Next.js Web App 連線測試
   - Supabase Client 初始化
   - 基本 SELECT 查詢
   - RLS 權限驗證

2. Expo Mobile App 連線測試
   - React Native Supabase Client
   - 離線資料同步機制
   - Session 管理

**執行條件**:
- ✅ 需先完成目標1 (資料庫測試通過)
- ✅ 需確認 `apps/web/.env.local` 配置正確
- ✅ 需確認 `apps/mobile/.env` 配置正確

**預期成果**:
- 能從前端成功查詢至少 3 張表的資料
- RLS Policy 正確阻擋未授權存取
- 無跨域 (CORS) 問題

---

## 📅 執行時程規劃

### Phase 1: 資料庫測試 (14:00 - 16:00)
```bash
⏰ 14:00-14:30 | 環境準備與備份
  - 確認 Docker Desktop 運作正常
  - 備份當前 Supabase 資料
  - 檢查 Migration 檔案完整性

⏰ 14:30-15:30 | Migration 執行與除錯
  - 執行 supabase db reset
  - 分析錯誤訊息並修復
  - 逐一驗證表格結構

⏰ 15:30-16:00 | RLS Policy 測試
  - 測試 Super Admin 全權限
  - 測試 Landlord 限定權限
  - 測試 Common User 基本權限
```

### Phase 2: 問題修復 (16:00 - 17:00)
```bash
⏰ 16:00-16:30 | 衝突解決
  - 修正表格命名衝突
  - 調整外鍵依賴順序
  - 更新 RLS Policy 語法

⏰ 16:30-17:00 | 重新測試
  - 再次執行 db reset
  - 確認所有問題已解決
```

### Phase 3: 前端整合 (17:00 - 18:00)
```bash
⏰ 17:00-17:30 | Web App 測試
  - 啟動 Next.js dev server
  - 測試 Supabase 連線
  - 查詢範例資料

⏰ 17:30-18:00 | Mobile App 測試
  - 啟動 Expo dev server
  - 測試資料同步
  - 撰寫測試報告
```

---

## 🔍 驗收標準

### 必須達成 (Must Have)
- [ ] ✅ Supabase db reset 成功執行無錯誤
- [ ] ✅ 68 張表格全部正確建立
- [ ] ✅ 所有 RLS Policy 已啟用
- [ ] ✅ 基本的 CRUD 操作可執行

### 期望達成 (Should Have)
- [ ] 🎯 Web App 能成功查詢至少 3 張表
- [ ] 🎯 Mobile App 能正常連線
- [ ] 🎯 撰寫整合測試報告文檔

### 可選達成 (Nice to Have)
- [ ] 💡 完成 Priority A 剩餘 8 張表的 migration
- [ ] 💡 建立自動化測試腳本
- [ ] 💡 更新 API 文檔

---

## 🚨 風險管理

### 高風險項目

#### 風險 1: Migration 執行失敗
**機率**: 40%  
**影響**: 高 - 阻擋所有後續工作  
**應對策略**:
1. 提前備份資料庫
2. 準備回滾腳本
3. 分批執行 migration（若全量失敗）
4. 記錄詳細錯誤訊息供除錯

#### 風險 2: 表格命名衝突
**機率**: 30%  
**影響**: 中 - 需重新命名部分表格  
**應對策略**:
1. 比對 `20260122000000_full_schema.sql` 與新建檔案
2. 統一命名規則 (snake_case vs PascalCase)
3. 更新所有引用該表格的 SQL

#### 風險 3: RLS Policy 過於嚴格導致無法查詢
**機率**: 25%  
**影響**: 中 - 需調整權限設定  
**應對策略**:
1. 使用 Supabase Studio 手動測試查詢
2. 臨時禁用 RLS 進行除錯
3. 參考官方 RLS 文檔調整 Policy

### 中低風險項目

#### 風險 4: 前端連線配置錯誤
**機率**: 20%  
**影響**: 低 - 僅影響整合測試  
**應對策略**:
1. 檢查 `.env.local` 環境變數
2. 確認 Supabase URL 與 API Key 正確
3. 使用 Postman 先測試 API

---

## 📊 成功指標 (KPI)

| 指標 | 目標值 | 測量方式 |
|------|--------|---------|
| Migration 成功率 | 100% | 所有檔案執行無錯誤 |
| 表格建立完整性 | 68/68 | `SELECT count(*) FROM information_schema.tables` |
| RLS Policy 覆蓋率 | 100% | 所有表格都有至少 1 條 policy |
| 前端查詢成功率 | ≥ 80% | 至少 3/5 張測試表可查詢 |
| 文檔完整性 | 100% | 所有執行步驟都有記錄 |

---

## 📝 產出文件清單

### 本次工作將產出以下文檔：

1. **測試執行報告**
   - 檔名: `資料庫整合測試報告_2026-01-30.md`
   - 位置: `docs/testing/`
   - 內容: Migration 執行結果、錯誤排除過程、RLS 測試結果

2. **前後端整合測試報告**
   - 檔名: `前後端整合測試_2026-01-30.md`
   - 位置: `docs/testing/`
   - 內容: Web/Mobile App 連線測試結果、問題清單

3. **Migration 修復記錄** (若需要)
   - 檔名: `migration_fixes_2026-01-30.sql`
   - 位置: `supabase/migrations/`
   - 內容: 修正衝突與錯誤的 SQL 補丁

4. **工作總結報告**
   - 檔名: `Claude每日工作總結_2026-01-30.md`
   - 位置: `docs/progress-reports/`
   - 內容: 今日完整工作成果、遇到的問題、明日計畫

---

## 💡 參考資源

### 技術文檔
- [Supabase Migration Guide](https://supabase.com/docs/guides/cli/local-development#database-migrations)
- [PostgreSQL RLS Documentation](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Supabase JavaScript Client](https://supabase.com/docs/reference/javascript/introduction)

### 專案內部文檔
- [資料庫遷移進度報告_2026-01-30.md](./資料庫遷移進度報告_2026-01-30.md)
- [DATABASE_MIGRATION_COMPLETION_REPORT_2026-01-30.md](../DATABASE_MIGRATION_COMPLETION_REPORT_2026-01-30.md)
- [supabase/migrations/README.md](../../supabase/migrations/README.md)

### 工具腳本
```bash
# Excel 分析工具
python3 scripts/deep_inspect_excel.py
python3 scripts/analyze_pending_tables.py
python3 scripts/update_excel_completion_status.py

# Supabase 指令
supabase status           # 檢查服務狀態
supabase db reset         # 重建資料庫
supabase db diff          # 檢查差異
supabase migration list   # 列出 migrations
```

---

## 🎯 立即行動清單

### 🔥 現在立即執行 (Next 30 mins)
1. [ ] 確認 Docker Desktop 運作中
2. [ ] 檢查 Supabase 本地服務狀態 (`supabase status`)
3. [ ] 備份當前資料庫 (`pg_dump` 或 Supabase Studio export)
4. [ ] 列出所有 migration 檔案並確認完整性
5. [ ] 執行 `supabase db reset`

### 📋 後續執行 (After initial test)
6. [ ] 分析執行結果與錯誤訊息
7. [ ] 修復發現的問題
8. [ ] 重新測試直到成功
9. [ ] 進行 RLS Policy 測試
10. [ ] 測試前端整合

---

## 🤝 協作備註

### 與 Gemini 的分工界線
- **Gemini**: Super Admin 相關功能 (~20 張表)
- **Claude (我)**: 其他所有角色功能 (48 張表 + 今日待補充)

### 需要 Gemini 協助的情況
- Super Admin RLS Policy 出現問題時
- RBAC 角色權限矩陣調整時
- 系統層級的 Webhook/ElasticSearch 整合時

### 獨立執行範圍
- Landlord, Tenant, Buyer, Agent 相關表格
- Common User 功能
- 前後端整合測試
- 文檔撰寫與更新

---

## 📈 預期時程總覽

```
14:00 ████████░░░░░░░░░░░░ 環境準備與備份
14:30 ░░░░░░░░████████████░░ Migration 執行測試
15:30 ░░░░░░░░░░░░░░░░████░░ RLS Policy 驗證
16:00 ░░░░░░░░░░░░░░░░░░████ 問題修復與調整
17:00 ░░░░░░░░░░░░░░░░░░░░██ 前端整合測試 (選)
18:00 ✅ 完成並撰寫報告
```

**預計總工時**: 4-5 小時  
**核心工作**: 2-3 小時 (目標1)  
**延伸工作**: 1-2 小時 (目標2-3)

---

## ✅ 最終交付物

### 必要交付
1. ✅ 完整運作的 Supabase 本地資料庫 (68 張表)
2. ✅ 資料庫整合測試報告
3. ✅ 問題修復記錄 (若有)
4. ✅ 每日工作總結報告

### 選擇性交付
5. 🎯 前後端整合測試報告
6. 🎯 Priority A 核心表格 migration (8 張)
7. 💡 自動化測試腳本

---

**報告編製**: Claude Sonnet 4.5  
**報告時間**: 2026-01-30 下午  
**開始執行時間**: 立即 (14:00)  
**預計完成時間**: 18:00

---

## 🚀 開始執行！

接下來我將立即開始執行**目標1: 資料庫整合測試**。

第一步: 檢查當前 Supabase 服務狀態...
